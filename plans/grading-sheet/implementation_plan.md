# Implementation Plan

[Overview]
Implement a Grading Sheet feature that lets authorized users generate a per-student grading sheet PDF for the globally selected term, with student selection via autocomplete and a toggle for Midterm vs Final grade column. The PDF must match the provided screenshots (letterhead, columns, and grading system block).

This feature spans backend (data aggregation and PDF rendering) and frontend (single-page UI under Academics accessible by registrar and faculty_admin roles). The term is sourced from the global TermService selection; the user chooses Period (Midterm/Final) and a Student via autocomplete, then downloads/opens the PDF.

The implementation uses existing infrastructure:
- Data source via DataFetcherService::getStudentRecordsByTerm(student_id, term, include_grades=true).
- PDF engine via tFPDF/FPDI (as used by InvoicePdf) with a new renderer class tailored to the grading sheet layout.
- Frontend AngularJS 1.x with the existing pui-autocomplete directive and TermService.

[Types]  
Introduce DTO/documented shapes for clarity across backend and frontend.

Backend (PHP, docblocks + array shapes):
- App\Services\Pdf\GradingSheetPdf::render(array $dto): string
  - $dto = [
    'header' => [
      'school_name'      => string,      // Information & Communications Technology, Inc. (iACADEMY)
      'title'            => string,      // Midterm Grade SY YYYY-YYYY Trimester N OR Finals Grade ...
      'program'          => string,      // Course from student data (computed)
      'term_label'       => string,      // e.g., "SY 2024-2025 Trimester 1" and/or "1st Term 2024-2025"
    ],
    'student' => [
      'number'           => string,      // strStudentNumber
      'name'             => string,      // Last, First Middle
    ],
    'period'             => 'midterm'|'final', // selected period
    'rows' => [ // one per enrolled/credited subject in the term
      [
        'code'           => string,      // subject code
        'title'          => string,      // descriptive title
        'units'          => float,       // subject units (0 allowed)
        'grade'          => string,      // display grade (numeric or remarks like F/FA/UD/OD/NGS)
        'units_earned'   => float,       // 0 when not passed; else equals units
        'include_gwa'    => int,         // 1|0 from subjects table
        'numeric_grade'  => float|null,  // normalized numeric (1.00..5.00) for GWA calc when applicable
        'passed'         => bool,        // derived based on rules below
      ],
      ...
    ],
    'summary' => [
      'gwa'              => float,       // computed using selected period’s numeric grades on include_gwa=1 rows
      'units_earned'     => float,       // sum of earned units
    ],
    'grading_system_notes' => string,    // static paragraph block as per screenshot
    'generated_by'      => string,       // faculty name (from header X-Faculty-ID or actor) or generated by label
    'generated_at'      => string,       // timestamp
    'logo_path'         => string|null,  // optional assets/img/iacademy-logo.png
  ];

Rules:
- Period=midterm → display grade from floatMidtermGrade; GWA uses numeric midterm when available on include_gwa=1 subjects.
- Period=final → display grade from floatFinalsGrade when present; fallback to floatFinalGrade if finals missing. GWA uses the selected period’s numeric.
- Map special grades to numeric 5.00 for GWA when string codes are in ['F','FA','UD','OD','NGS'].
- Passing and Units Earned:
  - Passed if numeric grade <= 3.0, or remarks contains 'passed' (case-insensitive), or explicit 'P'/'Passed' string grade.
  - Units earned = units when passed; else 0.

Frontend (JS doc-style for clarity):
- StudentOption: { id: number, student_number: string, last_name: string, first_name: string, middle_name: string }
- Term: { intID: number, strYearStart: number, strYearEnd: number, enumSem?: string, term_label?: string, ... }
- GradingSheetRequest: { student_id: number, syid: number, period: 'midterm'|'final' }

[Files]
Add new files and modify existing ones to introduce API endpoint, renderer, and SPA page under Academics.

- New Backend Files:
  - laravel-api/app/Services/GradingSheetService.php
    - Purpose: Aggregate records for a student and term, normalize grades per rules, compute GWA and units earned, build $dto for rendering.
  - laravel-api/app/Services/Pdf/GradingSheetPdf.php
    - Purpose: Render the $dto into a PDF string using FPDI/tFPDF; reproduce layout from screenshots (logo, header block, table, notes, footer line).

- Modify Backend Files:
  - laravel-api/app/Http/Controllers/Api/V1/ReportsController.php
    - Add method gradingSheetPdf(Request $request) that validates: student_id:int, syid:int, period: 'midterm'|'final'
    - Calls GradingSheetService->buildDto(), then app(GradingSheetPdf::class)->render($dto), and streams response inline (application/pdf).
  - laravel-api/routes/api.php
    - Add route: GET /api/v1/reports/grading-sheet/pdf → ReportsController@gradingSheetPdf
    - Middleware: role:registrar,faculty_admin,admin (by requirement).

- New Frontend Files:
  - frontend/unity-spa/features/academics/grading-sheet/grading-sheet.controller.js
    - Handles UI state: selectedStudentId, selectedPeriod, selectedTerm (from TermService), PDF generation.
    - Uses StudentsService and GradingSheetService.
  - frontend/unity-spa/features/academics/grading-sheet/grading-sheet.html
    - UI layout: Term (readonly from TermService), Student (pui-autocomplete), Period toggle (Midterm vs Final), Generate button, error state.
  - frontend/unity-spa/features/academics/grading-sheet/grading-sheet.service.js
    - Contains exportPdf({ student_id, syid, period }) to request the PDF (Accept: application/pdf, responseType: arraybuffer), open Blob in new tab.
    - Optional helpers for parsing filename from Content-Disposition.

- Modify Frontend Files:
  - frontend/unity-spa/core/routes.js
    - Register route "/academics/grading-sheet" → templateUrl and controller above.
  - frontend/unity-spa/core/roles.constants.js
    - Allow access to '^/academics/grading-sheet(?:/.*)?$' for roles ['registrar', 'faculty_admin', 'admin'].
  - frontend/unity-spa/shared/components/sidebar/sidebar.controller.js
    - Under "Academics" section, add menu item: { label: 'Grading Sheet', path: '/academics/grading-sheet' }, visible to registrar and faculty_admin (and admin).
  - frontend/unity-spa/index.html
    - Ensure scripts are included: features/academics/grading-sheet/grading-sheet.service.js and grading-sheet.controller.js
    - pui-autocomplete directive already included; TermSelector is globally available.

- Assets (optional):
  - If logo is required: reuse assets/img/iacademy-logo.png for PDF header. No additional assets needed.

[Functions]
Introduce new functions and modify a few existing modules to wire the feature.

- New Backend Functions:
  - App\Services\GradingSheetService::buildDto(int $studentId, int $syid, string $period, Request $request): array
    - Fetches: DataFetcherService::getStudentRecordsByTerm($studentId, (string)$syid, true)
    - Normalizes rows into dto['rows'] with code/title/units/grade/units_earned/include_gwa/numeric_grade/passed
    - Computes dto['summary'] (gwa, units_earned)
    - Builds header labels, resolves student name/number and program/course
    - Resolves generated_by from X-Faculty-ID → tb_mas_faculty, else request->user(), else null
  - App\Http\Controllers\Api\V1\ReportsController::gradingSheetPdf(Request $request)
    - Validates: ['student_id' => 'required|integer', 'syid' => 'required|integer', 'period' => 'required|in:midterm,final']
    - $dto = app(GradingSheetService::class)->buildDto(...)
    - $pdf = app(GradingSheetPdf::class)->render($dto)
    - return response($pdf, 200, ['Content-Type' => 'application/pdf', 'Content-Disposition' => 'inline; filename="grading-sheet-YYYYmmdd-HHMMSS.pdf"'])

- Modified Backend Functions:
  - laravel-api/routes/api.php: register the new route with role middleware.

- New Frontend Functions:
  - GradingSheetService.exportPdf({ student_id, syid, period }): Promise<boolean>
    - Sends GET to /api/v1/reports/grading-sheet/pdf with headers Accept: application/pdf, responseType: arraybuffer; opens Blob URL in new tab.
  - GradingSheetController.activate(): initializes selectedTerm from TermService; subscribes to termChanged; prepares default period='final' (or 'midterm' per UX preference).
  - GradingSheetController.onStudentQuery(q): fetches suggestions via StudentsService.listPage({ q, per_page: 20, page: 1 }) and binds to pui-source.
  - GradingSheetController.generate(): validates term/student/period then calls service to open PDF.

[Classes]
Introduce one new service and one new PDF renderer.

- New Classes:
  - App\Services\GradingSheetService
    - Methods: buildDto(); internal helpers (mapGradeToNumeric, isPassed, buildHeaderLabels)
    - Depends on DataFetcherService, DB facade, optional Campus/Term resolution
  - App\Services\Pdf\GradingSheetPdf
    - Methods: render(array $dto): string
    - Layout details:
      - Letterhead: school name + logo (assets/img/iacademy-logo.png) at top-left; header titles aligned per screenshot
      - Student block: Student Number, Student Name, Course
      - Table with columns: Course Code, Descriptive Title, Units, [Midterm Grade|Final Grade], Units Earned
      - Footer block: General Weighted Average (GWA), Total Units Earned
      - Grading System text block as static paragraph
      - Registrar signature line area (empty name)
      - Generated by/at footer small text

- Modified Classes:
  - ReportsController: add gradingSheetPdf action (no inheritance changes)

[Dependencies]
No new third-party packages required.
- Reuse setasign/fpdi + tFPDF already present (as used by InvoicePdf).
- Frontend reuses existing AngularJS, pui-autocomplete directive, and StudentsService/TermService.
- No DB migrations required.

[Testing]
Manual and programmatic validations to ensure correctness and parity with screenshots.

- Backend:
  - Unit-ish service test (manual via tinker/postman):
    - GET /api/v1/reports/grading-sheet/pdf?student_id=...&syid=...&period=midterm (registrar/faculty_admin/admin token + X-Faculty-ID header)
    - Check: 200 PDF, headings show “Midterm Grade”, table rows match term subjects, GWA computed as specified.
    - Repeat for period=final → “Final Grade” header.
  - Edge cases:
    - No numeric grade but remarks “Passed”/“P” → units earned > 0; numeric for GWA = treat as 3.00? (Default to 3.00 if strictly needed; else exclude from GWA if numeric unavailable; implementation will prefer mapping “P/Passed” to 3.00 for weighted average consistency unless instructed otherwise.)
    - Special grades (F/FA/UD/OD/NGS) → numeric 5.00; units earned = 0.
    - include_gwa=0 rows excluded from GWA but still shown in table.

- Frontend:
  - Access control: registrar and faculty_admin can open “Grading Sheet” under Academics.
  - Global term sync: switching term via sidebar updates page’s term label; generation uses current TermService.getSelectedTerm().intID
  - Student autocomplete: typing returns students; selecting sets vm.selectedStudentId; pressing Generate opens PDF in new tab.
  - Period toggle: affects PDF header and column label; both variants render correctly.

[Implementation Order]
Implement in the following sequence to minimize integration risk.

1. Backend service logic
   - Create App\Services\GradingSheetService::buildDto with grade normalization and GWA logic.
2. Backend PDF renderer
   - Create App\Services\Pdf\GradingSheetPdf::render reproducing layout and column header switching.
3. Controller endpoint
   - Add ReportsController::gradingSheetPdf and wire it to GradingSheetService + GradingSheetPdf.
4. Route registration
   - Add GET /api/v1/reports/grading-sheet/pdf; protect with role: registrar,faculty_admin,admin.
5. Frontend service
   - Create frontend/unity-spa/features/academics/grading-sheet/grading-sheet.service.js
6. Frontend UI
   - Create controller and HTML; student autocomplete + period toggle + Generate button; hook to TermService.
7. Menu and routing
   - Register route in core/routes.js.
   - Add sidebar item under Academics; add route access in core/roles.constants.js for registrar/faculty_admin/admin.
   - Include scripts in index.html.
8. Manual test and QA
   - Verify PDF both periods; validate GWA math and units earned; verify roles; cross-browser PDF open.
   - Tweak typography/coordinates for close visual parity with screenshots.

task_progress Items:
- [ ] Step 1: Implement GradingSheetService::buildDto with normalization, pass/fail, and GWA logic
- [ ] Step 2: Implement GradingSheetPdf::render to match screenshot layout and dynamic period header
- [ ] Step 3: Add ReportsController::gradingSheetPdf and register route /api/v1/reports/grading-sheet/pdf with role guard
- [ ] Step 4: Create GradingSheetService (frontend) to request PDF and open blob
- [ ] Step 5: Create Academics/Grading Sheet page controller + template with Term, Student autocomplete, Period toggle
- [ ] Step 6: Wire route, roles, and sidebar menu; include new scripts in index.html
- [ ] Step 7: Manual verification (both periods, role access) and adjustments
