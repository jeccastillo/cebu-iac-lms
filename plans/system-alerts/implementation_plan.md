# Implementation Plan

[Overview]
Implement a role-targeted, campus-scoped system alerts feature that displays a live-updating alert bar in the SPA header and persists per-user dismissals across sessions/devices.

This feature introduces a backend System Alerts domain in the Laravel API (CRUD, audience targeting, dismissal tracking, broadcasting) and a frontend AngularJS 1.x integration that renders alerts in the global header. Admins can create/manage alerts; alerts may also be system-generated by backend services. Delivery targets include specific roles, specific campuses, or all users. Live updates are delivered via Laravel broadcasting with a graceful polling fallback.

[Types]  
Define typed payloads for alerts, audience filters, and dismissals; formalize API contracts and event payloads.

- SystemAlert (API resource / DB entity)
  - id: number (PK)
  - title: string|null (max 255)
  - message: string (required; plain text or limited HTML as configured)
  - type: 'success'|'warning'|'error'|'info' (required)
  - target_all: boolean (default false) — if true, ignore roles/campuses filters
  - role_codes: string[] (lowercase role codes; JSON array; may be empty)
  - campus_ids: number[] (JSON array; may be empty)
  - starts_at: datetime|null (UTC; inclusive)
  - ends_at: datetime|null (UTC; inclusive)
  - intActive: tinyint 0|1 (soft-disable switch; default 1)
  - system_generated: tinyint 0|1 (default 0)
  - created_by: number|null (FK to users/faculty as available)
  - created_at: datetime
  - updated_at: datetime

- SystemAlertRead (dismissal record)
  - id: number (PK)
  - alert_id: number (FK to SystemAlert)
  - user_identifier: string (required; e.g., username|loginType; case-insensitive)
  - user_id: number|null (if available)
  - login_type: 'faculty'|'student'|string|null
  - campus_id: number|null (optional capture for auditing)
  - dismissed_at: datetime
  - created_at: datetime
  - updated_at: datetime
  - Unique constraint: (alert_id, user_identifier)

- API DTOs (request/response)
  - POST /system-alerts (admin)
    - body: { title?, message, type, target_all?, role_codes?, campus_ids?, starts_at?, ends_at?, system_generated? }
    - returns: { success, data: SystemAlert }
  - PUT /system-alerts/{id} (admin)
    - body: same as POST (partial accepted)
    - returns: { success, data: SystemAlert }
  - DELETE /system-alerts/{id} (admin)
    - soft disable (intActive=0) by default; hard-delete optional param
    - returns: { success }
  - GET /system-alerts (admin)
    - query: { page?, per_page?, active?, role_code?, campus_id?, system_generated? }
    - returns: { success, data: SystemAlert[], meta? }
  - GET /system-alerts/active (auth)
    - headers: { X-User-Roles?: 'admin,registrar,...', X-Campus-ID?: number, X-User-Name?: string, X-User-ID?: number, X-Login-Type?: string }
    - returns: { success, data: SystemAlert[] } — filtered for audience AND not dismissed by this user.
  - POST /system-alerts/{id}/dismiss (auth)
    - headers: same as above (to resolve user_identifier)
    - returns: { success }

- Broadcast event payload
  - channel: public: 'system.alerts' (simple), and/or granular:
    - 'system.alerts.roles.{code}' per role code
    - 'system.alerts.campus.{id}' per campus id
    - 'system.alerts.all'
  - message: { action: 'create'|'update'|'delete', alert: SystemAlert, timestamp }

[Files]
Introduce Laravel API models, migrations, controller, service, and events; add AngularJS service and header UI integration; optional Echo CDN include and configuration.

- New files to be created
  - laravel-api/app/Models/SystemAlert.php
    - Eloquent model for tb_sys_alerts; accessors for role_codes, campus_ids JSON.
  - laravel-api/app/Models/SystemAlertRead.php
    - Eloquent model for tb_sys_alert_reads.
  - laravel-api/database/migrations/2025_XX_XX_000000_create_tb_sys_alerts.php
    - Schema for SystemAlert.
  - laravel-api/database/migrations/2025_XX_XX_000001_create_tb_sys_alert_reads.php
    - Schema for SystemAlertRead with unique index.
  - laravel-api/app/Http/Controllers/Api/V1/SystemAlertController.php
    - REST + active + dismiss endpoints.
  - laravel-api/app/Services/SystemAlertService.php
    - Audience filtering; dismissal resolution; broadcasting helpers.
  - laravel-api/app/Events/SystemAlertBroadcasted.php
    - Implements ShouldBroadcast; carries action + alert.
  - laravel-api/routes/system_alerts.php (optional split) OR add into routes/api.php /v1 group.
  - laravel-api/config/system_alerts.php
    - Feature toggles (broadcast enabled, channels mode, max_active, default durations).
  - frontend/unity-spa/core/system-alerts.service.js
    - AngularJS service for fetching active, subscribing to broadcasts, and dismissing.
  - frontend/unity-spa/shared/components/header/system-alerts-bar.html
    - Partial template for top alert bar rendering.
  - docs/system-alerts.md
    - Ops notes: enabling broadcasting, Pusher keys, fallback behavior.

- Existing files to be modified
  - laravel-api/routes/api.php
    - Add routes (admin CRUD; active; dismiss) under /api/v1/system-alerts.
  - laravel-api/app/Providers/BroadcastServiceProvider.php (ensure) and config/broadcasting.php
    - Verify broadcasting driver; document env vars.
  - laravel-api/app/Providers/AuthServiceProvider.php
    - Add channel authorization if using private channels (optional).
  - frontend/unity-spa/index.html
    - Optionally include Laravel Echo + Pusher CDN with window flags; include system-alerts.service.js and header partial.
  - frontend/unity-spa/shared/components/header/header.controller.js
    - Inject SystemAlertsService; bind alert list; hook subscriptions; route change refresh.
  - frontend/unity-spa/shared/components/header/header.html
    - Insert ng-include for system-alerts-bar.html above current header content.

- Files to be deleted or moved
  - None.

- Configuration file updates
  - laravel-api/.env (deployment)
    - BROADCAST_DRIVER=pusher (or redis)
    - PUSHER_APP_ID=...
    - PUSHER_APP_KEY=...
    - PUSHER_APP_SECRET=...
    - PUSHER_APP_CLUSTER=...
  - frontend: window.BROADCAST_ENABLED, window.PUSHER_KEY, window.PUSHER_CLUSTER via index.html script block.

[Functions]
Add REST handlers, service methods, event dispatch, and frontend APIs; integrate header rendering and dismissal.

- New functions (backend)
  - SystemAlertService::filterForAudience(array $alerts, array $ctx): array
    - ctx: ['roles'=>string[], 'campus_id'=>?int, 'now'=>Carbon]
    - returns alerts matching target_all OR (roles intersect OR campus match) AND within time/window AND intActive=1.
  - SystemAlertService::userIdentifier(Request $req): string
    - Derive stable identifier e.g., strtolower(username).'|'.strtolower(loginType), fallback to header/claims.
  - SystemAlertService::broadcast(string $action, SystemAlert $alert): void
    - Dispatch SystemAlertBroadcasted with channel selection per config.
  - SystemAlertController::index(Request $req)
  - SystemAlertController::store(SystemAlertStoreRequest $req)
  - SystemAlertController::update(SystemAlertUpdateRequest $req, int $id)
  - SystemAlertController::destroy(int $id)
  - SystemAlertController::active(Request $req)
  - SystemAlertController::dismiss(Request $req, int $id)

- New functions (frontend)
  - SystemAlertsService.getActive(): Promise<SystemAlert[]>
    - GET API_BASE + '/system-alerts/active' with headers: X-User-Roles, X-Campus-ID, X-User-Name, X-Login-Type, X-User-ID.
  - SystemAlertsService.dismiss(id): Promise<void>
    - POST API_BASE + '/system-alerts/{id}/dismiss'
  - SystemAlertsService.subscribe(cb): unsubscribeFn
    - If BROADCAST_ENABLED and Echo present: subscribe channels; on event, cb({ action, alert })
    - Else: start interval poll (e.g., 30s) to refresh; provide unsubscribe to clear.
  - HeaderController integration
    - initAlerts(): fetch + subscribe; vm.alerts []; vm.dismiss(a)
    - $rootScope.$on('$routeChangeStart'): maybe refresh depending on policy.

- Modified functions
  - None removed; header controller gains integration methods.

- Removed functions
  - None.

[Classes]
Introduce Laravel models and event; optional form requests for validation.

- New classes
  - App\Models/SystemAlert
    - $table='tb_sys_alerts'; $casts=['role_codes'=>'array','campus_ids'=>'array','target_all'=>'boolean','intActive'=>'integer','system_generated'=>'boolean','starts_at'=>'datetime','ends_at'=>'datetime'];
  - App\Models/SystemAlertRead
    - $table='tb_sys_alert_reads'; belongsTo(SystemAlert).
  - App\Events\SystemAlertBroadcasted implements ShouldBroadcast
    - public $action; public $alert; public function broadcastOn(): array (channels based on config)
    - broadcastAs(): 'system.alert'
  - App\Http\Controllers\Api\V1\SystemAlertController
  - App\Services\SystemAlertService

- Modified classes
  - App\Providers\BroadcastServiceProvider (ensure routes()).
  - App\Providers\AuthServiceProvider (only if using private channels; add Broadcast::channel rules).

- Removed classes
  - None.

[Dependencies]
Add optional CDN Echo/Pusher client; leverage existing Laravel broadcasting stack.

- Backend
  - Use Laravel built-in broadcasting; recommend pusher as BROADCAST_DRIVER initially for lower friction.
  - No composer deps required beyond default (laravel/framework). If needed for Redis broadcasting, ensure predis/phpredis configured.

- Frontend (CDN via index.html, optional)
  - https://cdn.jsdelivr.net/npm/pusher-js@7
  - https://cdn.jsdelivr.net/npm/laravel-echo@1
  - Controlled by window.BROADCAST_ENABLED and window.PUSHER_* config in index.html.

[Testing]
Implement unit and integration tests for filtering, dismissal, and API correctness; manual verification for header UI and broadcast.

- Backend tests (phpunit)
  - tests/Feature/SystemAlertsTest.php
    - it_lists_active_alerts_filtered_by_role
    - it_lists_active_alerts_filtered_by_campus
    - it_excludes_dismissed_alerts_for_user
    - it_honors_time_window_and_intActive
    - admin_can_crud_alerts
  - tests/Unit/SystemAlertServiceTest.php
    - audience filtering edge cases (empty roles, target_all, overlapping scopes)

- Frontend tests (manual / smoke)
  - Verify alerts bar renders with variants for success/warning/error/info.
  - Dismiss button persists across reloads (calls API).
  - Live update appears when a new alert is created (Echo) or within poll interval.

[Implementation Order]
Backend first (data & APIs), then broadcasting hooks, then frontend service/UI, then tests and documentation.

1) Database
   - Create migrations for tb_sys_alerts and tb_sys_alert_reads; run migrate.
2) Backend domain
   - Add models (SystemAlert, SystemAlertRead) and SystemAlertService (filter, identifier, broadcast).
3) API endpoints
   - Implement SystemAlertController (index/store/update/destroy/active/dismiss); wire routes in routes/api.php under /v1 (admin guard where specified).
4) Broadcasting
   - Implement SystemAlertBroadcasted event; dispatch on create/update/delete; add config/system_alerts.php toggles.
   - Verify BROADCAST_DRIVER and Pusher env in .env; enable BroadcastServiceProvider routes.
5) Frontend plumbing
   - Add core/system-alerts.service.js with fetch/dismiss/subscribe (Echo + fallback polling).
   - Gate request headers using existing StorageService and RoleService (X-User-Roles, X-User-Name, X-Login-Type, X-User-ID, X-Campus-ID).
6) Header integration
   - Create shared/components/header/system-alerts-bar.html (top bar); modify header.html to include it above current header; update header.controller.js to initialize and manage alerts.
7) Optional Echo client
   - In index.html, add conditional Echo/Pusher CDN includes and window flags (BROADCAST_ENABLED, PUSHER_KEY, PUSHER_CLUSTER). Ensure this does not break when env not set (fallback to polling).
8) Admin UI (optional phase 2)
   - Create admin CRUD screens under features/admin/system-alerts/* gated to admin role.
9) Testing and docs
   - Add PHP tests; perform manual UI verification; write docs/system-alerts.md for ops.
