# Implementation Plan

[Overview]
Add a detailed tuition breakdown to the registrar Registration Form PDF generated by UnityController::regForm, matching the provided screenshot columns and sections.

The Registration Form PDF currently renders student header data, a subjects table, and a minimal Assessment summary with only totals. This implementation adds a comprehensive Assessment Summary (Full, 50% Down, 30% Down), a Miscellaneous Detail table, and an Other Fees Detail (New Student Fees) block. The data will be sourced from the existing TuitionService->compute() output to keep all computations centralized and already consistent with cashier and tuition-saving logic. Where the existing output does not expose a dedicated list (New Student Fees), we will minimally enhance TuitionService->compute to return that list explicitly without altering current consumers.

[Types]  
No new PHP classes; augment existing compute() response shape.

Type additions and structures (associative arrays):
- TuitionService::compute(...) return additions:
  - items.new_student: array<{ name: string, amount: float }>
  - items.misc: already present as array<{ name: string, amount: float }>
  - summary.installments: already present with keys:
    - total_installment, total_installment30, total_installment50: float
    - down_payment, down_payment30, down_payment50: float
    - installment_fee, installment_fee30, installment_fee50: float
- Field specifications:
  - items.new_student: derived from TuitionCalculator::computeMiscFees(...) return['new_student_list']; enumerate each entry as:
    - name: string (e.g., "Matriculation", "Orientation", "Handbook", "ID")
    - amount: number (2 decimals)
  - items.misc: unchanged; list of all misc items for the selected tuition year pack.
  - summary totals used by PDF:
    - tuition: float
    - lab_total: float
    - misc_total: float
    - additional_total: float (not directly printed in the screenshot; only the subset “New Student Fees” is shown under Other Fees Detail)
    - total_due: float

[Files]
Modify two existing backend files; no new routes or config.

- Existing files to be modified
  1) laravel-api/app/Services/TuitionService.php
     - Change: Include a dedicated items.new_student array in the compute(...) return payload built from $newStudentList (kept during computeMiscFees stage). Do not change current sums; continue to add new-student fees into items.additional and to additional_total as before. This change only exposes a new read path for the PDF.
  2) laravel-api/app/Http/Controllers/Api/V1/UnityController.php
     - Change: Expand regForm() PDF layout to draw:
       - “ASSESSMENT SUMMARY” table with three columns: FULL PAYMENT, 50% DOWN PAYMENT, 30% DOWN PAYMENT.
         - Full column rows: Tuition Fee, Laboratory, Miscellaneous, Other Fees (new student fees total), Total (bold).
         - 50%/30% columns: Total (installment total), Down Payment, 1st–5th INSTALLMENT amounts (equal per compute result).
       - “MISCELLANEOUS DETAIL” list: each items.misc row with amount and a Total line.
       - “OTHER FEES DETAIL — NEW STUDENT FEES” list: each items.new_student row with amount and a Total line.
     - Add small local helper closures inside regForm for:
       - money($x): string number_format(2)
       - drawColumnHeader($x, $y, $label)
       - drawRow($x, $y, $label, $amount, $align)
       - drawKeyValueList($x, $y, $title, $rows)
     - Keep the current font families and sizes consistent with existing content. Align positions to fit A4 width without overlapping the subjects table.

- New files to be created
  - None

- Files to be deleted or moved
  - None

- Configuration file updates
  - None

[Functions]
Modify one service function and one controller action.

- New functions
  - None (only add small local helper closures inside regForm for drawing).

- Modified functions
  1) TuitionService::compute(string $studentNumber, int $syid, ?int $discountId = null, ?int $scholarshipId = null): array
     - Required change:
       - After building $newStudentList and $newStudentTotal, push a new array under $items:
         items['new_student'] = array_map of $newStudentList to [{ name, amount }]
       - Do not change $additionalTotal or items['additional'] population; this is read-only exposure for the PDF.
  2) UnityController::regForm(Request $request)
     - Required changes:
       - After $breakdown = $this->tuition->compute(...):
         - Extract $sum = $breakdown['summary'] ?? []
         - Extract $items = $breakdown['items'] ?? []
         - Compute $newStudentTotal = sum of items.new_student amounts (0 when missing)
       - Draw “ASSESSMENT SUMMARY” headers and three columns:
         - Column X positions: FULL at ~16mm, 50% at ~78mm, 30% at ~140mm (tuned to A4 width and existing layout).
         - Full column:
           Tuition Fee = $sum['tuition']; Laboratory = $sum['lab_total']; Miscellaneous = $sum['misc_total']; Other Fees = $newStudentTotal; Total = $sum['total_due'] (bold).
         - 50% column:
           Total = $sum['installments']['total_installment50']; Down Payment = $sum['installments']['down_payment50']; 1st–5th INSTALLMENT = each $sum['installments']['installment_fee50'].
         - 30% column:
           Total = $sum['installments']['total_installment30']; Down Payment = $sum['installments']['down_payment30']; 1st–5th INSTALLMENT = each $sum['installments']['installment_fee30'].
       - Draw “MISCELLANEOUS DETAIL” block (left of page under assessment), listing items.misc with aligned amounts and a “Total” line using $sum['misc_total'].
       - Draw “OTHER FEES DETAIL — NEW STUDENT FEES” block (right of page under assessment), listing items.new_student with a “Total” line using $newStudentTotal.
       - Use defensive checks (is_array, isset) to avoid runtime notices when lists are empty.

- Removed functions
  - None

[Classes]
No class additions or removals.

- New classes
  - None

- Modified classes
  - None (only method contents change).

- Removed classes
  - None

[Dependencies]
No dependency modifications.

No new Composer packages. Continue using setasign/fpdi for PDF. All data pulled from TuitionService and existing DB tables.

[Testing]
Manual API verification and visual inspection.

- API endpoint:
  - GET {API_BASE}/unity/reg-form?student_number={SN}&amp;term={SYID}
- Expected results:
  - HTTP 200 with Content-Type: application/pdf and inline Content-Disposition with a filename.
  - PDF shows:
    - Header fields intact (Student No, Name, Program, Term, Address).
    - Subjects table unchanged.
    - New “ASSESSMENT SUMMARY” with three columns (values align to TuitionService->compute output).
    - “MISCELLANEOUS DETAIL” with each misc item and total equals summary.misc_total.
    - “OTHER FEES DETAIL — NEW STUDENT FEES” equals the sum of items.new_student.
- Edge cases:
  - Student without registration or tuition_year: controller already handles via TuitionService exceptions; PDF section guarded when $breakdown missing.
  - Empty misc/new-student lists: render table headers and “Total 0.00”.
- Data spot checks:
  - Compare 50% and 30% totals, DP, installment amounts with values from GET /unity/tuition-preview or saved tuition snapshots to ensure consistency.

[Implementation Order]
Implement service exposure first, then controller PDF layout.

1) Update TuitionService::compute to include items.new_student array (read-only exposure).
2) Update UnityController::regForm to:
   - Extract relevant totals and lists from compute output.
   - Render “ASSESSMENT SUMMARY” three-column block with correct math.
   - Render “MISCELLANEOUS DETAIL” list and total.
   - Render “OTHER FEES DETAIL — NEW STUDENT FEES” list and total.
3) Smoke test endpoint in browser for a known student/term; visually verify layout and numbers.
4) Adjust X/Y positions and column widths if minor overflows occur on particular data (long program names are already handled via MultiCell where applicable).
5) Final validation with a second student/term to ensure robustness.

# Implementation Plan

[Overview]
Add footer content to UnityController::regForm to match the screenshot: two top signature headings with blank fields (“Official Receipt Number/date ____”, “Enrollment Confirmed by: ____”), dual signature lines with captions (“Authorized Signatory”, “Registrar”), a left “Note: Class schedule is subject to change”, a right “Generated: {datetime} by {name}”, the policy paragraphs with bullet points, a late enrollment penalty line, and a centered “Student Signature/Date” line at the very bottom. All elements are drawn on the same PDF page under the existing content.

This update augments the existing PDF renderer only. The date/time will be generated at runtime, and the “by {name}” will be resolved from the acting faculty using UserContextResolver; if unavailable, omit the name. The “Official Receipt Number/date” and “Enrollment Confirmed by” remain blank placeholders as in the screenshot.

[Types]  
No schema or API type changes.

We will read:
- Acting faculty: resolve via UserContextResolver::resolveUserId($request) -> tb_mas_faculty.intID; read faculty fields strFirstname/strLastname (or name composite) when available.

[Files]
Only one backend file will be modified.

- Existing files to be modified
  - laravel-api/app/Http/Controllers/Api/V1/UnityController.php
    - Add footer drawing immediately after the current Assessment section and before Output().
    - Introduce small local helper closures (money already present above) for text wrapping and horizontal lines.
    - Compute acting faculty name via UserContextResolver with graceful fallback.

- New files to be created
  - None

- Files to be deleted or moved
  - None

- Configuration file updates
  - None

[Functions]
Modify one controller action; no new public APIs.

- Modified functions
  - UnityController::regForm(Request $request)
    - Resolve actor:
      - $actorId = $this->ctx->resolveUserId($request) or from X-Faculty-ID header; lookup tb_mas_faculty where intID = $actorId to build $actorName = "Firstname Lastname" (fallback: null).
    - Build formatted timestamp $generatedAt = now()->format('Y-m-d h:i A'); optionally append actor “by {$actorName}” when present.
    - Footer layout (A4, mm):
      - Start anchor Y ≈ 200 (ensure it is below assessment; clamp to avoid overlap).
      - Row 1 (top line within footer area):
        - Left: “Official Receipt Number/date _______________________”
        - Right: “Enrollment Confirmed by: _______________________”
      - Row 2 (signature lines):
        - Two horizontal lines with captions centered below:
          - Left caption: “Authorized Signatory”
          - Right caption: “Registrar”
      - Row 3 (meta row):
        - Left: “Note: Class schedule is subject to change”
        - Right: “Generated: {generatedAt}{optional ‘ by {name}’}”
      - Policy text block (multi-line paragraphs):
        - Title: “Policy on School Charges and Refund of Fees”
        - Paragraph lines exactly as in the screenshot (see Testing for text).
        - Bulleted list (•) with three items for 25%/50%/100% refund rules.
        - Standalone sentence: “One-time penalty for the late enrollment (PhP 500.00) shall be charged after the first day of official start of classes per term.”
      - Bottom signature:
        - Centered line “_______________________________”
        - Caption centered below: “Student Signature/Date”
    - Use SetFont Helvetica 7–8pt; use MultiCell for paragraphs; use SetXY/Cell for headings; ensure text stays within margins (L=10, R=200).

- New functions
  - None (helper closures local to regForm only).

- Removed functions
  - None

[Classes]
No class additions, removals, or inheritance changes.

[Dependencies]
No new Composer packages.

[Testing]
Manual verification through the existing endpoint.

- Endpoint:
  - GET {API_BASE}/v1/unity/reg-form?student_number={SN}&term={SYID}
- Expected:
  - PDF renders the new footer elements on the same page:
    - Placeholders for OR/date and Enrollment Confirmed by (blank lines).
    - Two signature lines with “Authorized Signatory” and “Registrar”.
    - Left note and right generated line (with name when resolvable).
    - Policy header, paragraph, bullet list, and late enrollment penalty line.
    - Centered Student Signature/Date line at the bottom.
- Data resolution:
  - Actor name is populated when UserContextResolver resolves a faculty id (or X-Faculty-ID header).
  - If not resolved, omit “by {name}” in the Generated text.
- Layout validation:
  - Ensure no overlap with content above; if the assessment block runs long, clamp and start footer no earlier than y=200 and use MultiCell to wrap paragraphs within page bounds.

[Implementation Order]
Perform the controller modification in small, testable increments.

1) Add actor resolution (UserContextResolver + faculty lookup) and compute $generatedAt/$generatedBy string.
2) Implement top footer row (OR/date and Enrollment Confirmed by) with placeholder lines.
3) Add dual signature lines and captions (Authorized Signatory, Registrar).
4) Add left note and right generated text line.
5) Add policy header, multi-paragraph text, bullet list, and penalty sentence using MultiCell wrapping.
6) Add centered “Student Signature/Date” line at the page bottom.
7) Smoke test with 2–3 students/terms and adjust X/Y positions if any overlap or wrapping issues occur.
