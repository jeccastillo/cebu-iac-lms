<div class="space-y-6">
  <h1 class="text-2xl font-semibold">Registrar Enlistment</h1>

  <!-- Controls -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-700">Student</label>            
      <select ng-model="vm.studentNumber"
              ng-options="s.student_number as (s.student_number + ' — ' + s.last_name + ', ' + s.first_name + (s.middle_name ? (' ' + s.middle_name) : '')) for s in vm.students track by s.student_number"
              ng-change="vm.onStudentSelected()"
              select2
              select2-watch="vm.students"
              select2-allow-clear
              data-placeholder="Search or select a student..."
              class="mt-1 block w-full border rounded px-3 py-2">
        <option value=""></option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Term</label>
      <div class="mt-1 block w-full border rounded px-3 py-2 bg-gray-50">
        <span ng-if="vm.selectedTerm">
          {{ vm.selectedTerm.enumSem }} {{ vm.selectedTerm.term_label }} {{ vm.selectedTerm.strYearStart }}-{{ vm.selectedTerm.strYearEnd }}
        </span>
        <span ng-if="!vm.selectedTerm" class="text-gray-500">Select a term from the global selector.</span>
      </div>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Year Level</label>
      <input type="number" min="1" ng-model="vm.yearLevel" class="mt-1 block w-full border rounded px-3 py-2" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Student Type</label>
      <select ng-model="vm.studentType" class="mt-1 block w-full border rounded px-3 py-2">
        <option value="continuing">Continuing</option>
        <option value="new">New</option>
        <option value="returnee">Returnee</option>
        <option value="transfer">Transfer</option>
      </select>
    </div>
  </div>  

  <div class="flex items-center gap-3">    
    <button class="px-4 py-2 bg-red-700 text-white rounded hover:bg-red-800"
            ng-click="vm.resetRegistration()">
      Reset Registration
    </button>
    <span ng-if="vm.loading" class="text-gray-600">
      <i class="fas fa-spinner fa-spin"></i> Loading...
    </span>
  </div>

  <!-- Current enlisted -->
  <div class="bg-white border rounded p-4">
    <div ng-if="vm.selectedStudentName" class="text-sm text-gray-700 mb-1 flex items-center justify-between">
      <span>Student: <span class="font-semibold">{{vm.selectedStudentName}}</span></span>
      <a ng-if="vm.studentNumber" 
         href="#/students/{{vm.student_id}}/records?sn={{vm.studentNumber}}" 
         target="_blank" 
         class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
        <i class="fas fa-external-link-alt"></i> View Records
      </a>
    </div>
    <h2 class="text-lg font-semibold mb-3">Current Enlisted (Selected Term)</h2>
    <div ng-if="!vm.current.length" class="text-gray-500">No enlisted classes loaded.</div>
    <table ng-if="vm.current.length" class="min-w-full text-sm">
      <thead>
        <tr class="text-left border-b">
          <th class="py-2 pr-4">Code</th>
          <th class="py-2 pr-4">Description</th>
          <th class="py-2 pr-4">Section</th>
          <th class="py-2 pr-4">Units</th>
          <th class="py-2 pr-4">Classlist ID</th>
        </tr>
      </thead>
      <tbody>
          <tr ng-repeat="c in vm.current" class="border-b">
            <td class="py-2 pr-4 font-mono">{{c.code}}</td>
            <td class="py-2 pr-4">{{c.description}}</td>
            <td class="py-2 pr-4 font-mono">{{c.section_code}}</td>
            <td class="py-2 pr-4">{{c.units}}</td>
            <td class="py-2 pr-4 font-mono">{{c.classlist_id}}</td>
          </tr>
      </tbody>
    </table>
  </div>

  <!-- Registration Details -->
  <div class="bg-white border rounded p-4 space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Registration Details</h2>
      <span ng-if="vm.regLoading" class="text-gray-600 text-sm">
        <i class="fas fa-spinner fa-spin"></i> Loading registration...
      </span>
    </div>

    <!-- Notice when no reg exists -->
    <div ng-if="!vm.registration" class="text-gray-600 bg-gray-50 border rounded p-3">
      No registration for this term. This form allows editing only when a registration already exists.
    </div>

    <!-- Editable form when reg exists -->
    <div ng-if="vm.registration" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Left: Current Registration (read-only) -->
      <div class="bg-gray-50 border rounded p-4">
        <h3 class="font-semibold text-gray-700 mb-3">Current Values</h3>
        <div class="space-y-2 text-sm">
          <div>
            <div class="text-gray-500 uppercase text-xs">Year Level</div>
            <div class="font-medium">{{ (vm.registration.intYearLevel || vm.registration.int_year_level || vm.regForm.intYearLevel) || '—' }}</div>
          </div>
          <div>
            <div class="text-gray-500 uppercase text-xs">Student Type</div>
            <div class="font-medium">{{ vm.registration.enumStudentType || vm.registration.student_type || '—' }}</div>
          </div>
          <div>
            <div class="text-gray-500 uppercase text-xs">Payment Type</div>
            <div class="font-medium">{{ vm.registration.paymentType || '—' }}</div>
          </div>
          <div>
            <div class="text-gray-500 uppercase text-xs">Program</div>
            <div class="font-medium">
              {{ vm.programLabel(vm.findProgramById(vm.registration.current_program)) || '—' }}
            </div>
          </div>
          <div>
            <div class="text-gray-500 uppercase text-xs">Curriculum</div>
            <div class="font-medium">
              {{ vm.curriculumLabel(vm.findCurriculumById(vm.registration.current_curriculum)) || '—' }}
            </div>
          </div>
          <div>
            <div class="text-gray-500 uppercase text-xs">Tuition Year</div>
            <div class="font-medium">
              {{ vm.tuitionYearLabel(vm.registration.tuition_year) || '—' }}
            </div>
          </div>
          <div>
            <div class="text-gray-500 uppercase text-xs">Withdrawal Period</div>
            <div class="font-medium">
              {{ vm.readableWithdrawalPeriod(vm.registration.withdrawal_period) || '—' }}
            </div>
          </div>
          <div>
            <div class="text-gray-500 uppercase text-xs">LOA Remarks</div>
            <div class="font-medium whitespace-pre-line">{{ vm.registration.loa_remarks || '—' }}</div>
          </div>
        </div>
      </div>

      <!-- Right: Editable Form -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Year Level -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Year Level</label>
          <input type="number" min="1" ng-model="vm.regForm.intYearLevel" class="mt-1 block w-full border rounded px-3 py-2" />
        </div>

        <!-- Student Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Student Type</label>
          <select ng-model="vm.regForm.enumStudentType" class="mt-1 block w-full border rounded px-3 py-2">
            <option value="continuing">Continuing</option>
            <option value="new">New</option>
            <option value="returnee">Returnee</option>
            <option value="transfer">Transfer</option>
          </select>
        </div>

        <!-- Payment Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Payment Type</label>
          <select ng-model="vm.regForm.paymentType" class="mt-1 block w-full border rounded px-3 py-2">
            <option value="">-- Select Payment Type --</option>
            <option value="full">Full</option>
            <option value="partial">Partial</option>
          </select>
        </div>

        <!-- Program -->
        <div class="md:col-span-1">
          <label class="block text-sm font-medium text-gray-700">Program</label>
          <select ng-model="vm.regForm.current_program"
                  ng-change="vm.loadCurricula(vm.regForm.current_program)"
                  class="mt-1 block w-full border rounded px-3 py-2"
                  ng-options="(p.intProgramID || p.id) as vm.programLabel(p) for p in vm.programs track by (p.intProgramID || p.id)">
            <option value="">-- Select Program --</option>
          </select>
        </div>

        <!-- Curriculum -->
        <div class="md:col-span-1">
          <label class="block text-sm font-medium text-gray-700">Curriculum</label>
          <select ng-model="vm.regForm.current_curriculum"
                  class="mt-1 block w-full border rounded px-3 py-2"
                  ng-options="(c.intID || c.id) as (c.strName || c.name) for c in vm.curricula track by (c.intID || c.id)">
            <option value="">-- Select Curriculum --</option>
          </select>
        </div>

        <!-- Tuition Year -->
        <div class="md:col-span-1">
          <label class="block text-sm font-medium text-gray-700">Tuition Year</label>
          <select ng-model="vm.regForm.tuition_year"
                  ng-options="ty.intID as (ty.year || ty.label) for ty in vm.tuitionYears track by ty.intID"
                  class="mt-1 block w-full border rounded px-3 py-2">
            <option value="">-- Select Tuition Year --</option>
          </select>
        </div>

        <!-- Withdrawal Period -->
        <div class="md:col-span-1">
          <label class="block text-sm font-medium text-gray-700">Withdrawal Period</label>
          <select ng-model="vm.regForm.withdrawal_period" class="mt-1 block w-full border rounded px-3 py-2">
            <option value="">-- Select Withdrawal Period --</option>
            <option value="before">Before</option>
            <option value="start">Start</option>
            <option value="end">End</option>
          </select>
        </div>

        <!-- LOA Remarks -->
        <div class="md:col-span-3">
          <label class="block text-sm font-medium text-gray-700">LOA Remarks</label>
          <textarea ng-model="vm.regForm.loa_remarks" rows="3" maxlength="1000" class="mt-1 block w-full border rounded px-3 py-2" placeholder="Leave-of-absence remarks"></textarea>
        </div>

        <!-- Actions -->
        <div class="md:col-span-3 flex items-center gap-3">
          <button class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                  ng-disabled="!vm.isRegDirty() || vm.regSaving"
                  ng-click="vm.saveRegistration()">
            <span ng-if="!vm.regSaving">Save Registration</span>
            <span ng-if="vm.regSaving"><i class="fas fa-spinner fa-spin"></i> Saving...</span>
          </button>
          <button class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                  ng-click="vm.resetRegForm()"
                  ng-disabled="vm.regSaving || !vm.registration">
            Reset
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tuition Details -->
  <div class="bg-white border rounded p-4 space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Tuition Details</h2>
      <div class="flex items-center gap-2">
        <button class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
                ng-click="vm.loadTuition(true)"
                ng-disabled="vm.tuitionLoading || !vm.studentNumber || !vm.term || !vm.current.length">
          <span ng-if="!vm.tuitionLoading">Load Tuition</span>
          <span ng-if="vm.tuitionLoading"><i class="fas fa-spinner fa-spin"></i> Loading...</span>
        </button>
        <button class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                ng-click="vm.saveTuition()"
                ng-disabled="vm.tuitionSaving || !vm.canSaveTuition()">
          <span ng-if="!vm.tuitionSaving">Save Tuition</span>
          <span ng-if="vm.tuitionSaving"><i class="fas fa-spinner fa-spin"></i> Saving...</span>
        </button>
      </div>
    </div>

    <div ng-if="vm.tuitionLoading" class="text-gray-600 text-sm">
      <i class="fas fa-spinner fa-spin"></i> Computing tuition preview...
    </div>

    <div ng-if="!vm.tuitionLoading && !vm.tuition" class="text-gray-500">
      No tuition loaded yet. Select a student and term with enlisted subjects, then click “Load Tuition”.
    </div>

    <div ng-if="!vm.tuitionLoading && vm.tuition" class="space-y-4">
      <!-- Installment Tabs -->
      <div class="flex items-center gap-2">
        <button class="px-3 py-1 rounded text-sm"
                ng-class="{'bg-indigo-600 text-white': vm.installmentTab==='standard', 'bg-gray-200 text-gray-700': vm.installmentTab!=='standard'}"
                ng-click="vm.selectInstallmentTab('standard')">Standard</button>
        <button class="px-3 py-1 rounded text-sm"
                ng-class="{'bg-indigo-600 text-white': vm.installmentTab==='dp30', 'bg-gray-200 text-gray-700': vm.installmentTab!=='dp30'}"
                ng-click="vm.selectInstallmentTab('dp30')">30% DP</button>
        <button class="px-3 py-1 rounded text-sm"
                ng-class="{'bg-indigo-600 text-white': vm.installmentTab==='dp50', 'bg-gray-200 text-gray-700': vm.installmentTab!=='dp50'}"
                ng-click="vm.selectInstallmentTab('dp50')">50% DP</button>
      </div>

      <!-- Installment Figures -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm" ng-if="vm.tuition.summary.installments">
        <div class="bg-white border rounded p-3">
          <div class="text-gray-500 uppercase text-xs">Down Payment</div>
          <div class="font-semibold">₱ {{ (vm.installmentData() && vm.installmentData().dp || 0) | number:2 }}</div>
        </div>
        <div class="bg-white border rounded p-3">
          <div class="text-gray-500 uppercase text-xs">Per-Installment (x5)</div>
          <div class="font-semibold">₱ {{ (vm.installmentData() && vm.installmentData().fee || 0) | number:2 }}</div>
        </div>
        <div class="bg-white border rounded p-3">
          <div class="text-gray-500 uppercase text-xs">Total Installment</div>
          <div class="font-semibold">₱ {{ (vm.installmentData() && vm.installmentData().total || 0) | number:2 }}</div>
        </div>
      </div>
      <div class="text-gray-500 text-xs" ng-if="!vm.tuition.summary.installments">
        Installment details unavailable.
      </div>
      <!-- Installment Scheme Notes -->
      <div class="text-xs text-gray-600" ng-if="vm.tuition.summary.installments">
        <div ng-if="vm.installmentTab === 'standard'">
          Note: Standard uses installment increase
          <span class="font-semibold">{{ (vm.tuition.meta &amp;&amp; vm.tuition.meta.installment_increase_percent) || 0 }}%</span>
          applied to Tuition and Lab. Misc and Additional are unchanged.
        </div>
        <div ng-if="vm.installmentTab === 'dp30'">
          Note: 30% DP applies increases to Tuition <span class="font-semibold">+15%</span> and Misc
          <span class="font-semibold">+15%</span>. Lab and Additional are unchanged.
        </div>
        <div ng-if="vm.installmentTab === 'dp50'">
          Note: 50% DP applies increases to Tuition <span class="font-semibold">+9%</span> and Misc
          <span class="font-semibold">+9%</span>. Lab and Additional are unchanged.
        </div>
      </div>

      <!-- Summary -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
        <div class="bg-gray-50 border rounded p-3">
          <div class="text-gray-500 uppercase text-xs">Tuition</div>
          <div ng-if="(vm.installmentTab === 'dp30' || vm.installmentTab === 'dp50') && vm.increaseInfo()" class="font-semibold">
            ₱ {{ (vm.increaseInfo().tuitionNew || 0) | number:2 }}
          </div>
          <div ng-if="vm.installmentTab === 'standard'" class="font-semibold">
            ₱ {{ (vm.tuition.summary.tuition || 0) | number:2 }}
          </div>          
        </div>
        <div class="bg-gray-50 border rounded p-3">
          <div class="text-gray-500 uppercase text-xs">Misc</div>
          <div class="font-semibold">₱ {{ (vm.tuition.summary.misc_total || 0) | number:2 }}</div>
        </div>
        <div class="bg-gray-50 border rounded p-3">
          <div class="text-gray-500 uppercase text-xs">Lab</div>
          <div ng-if="(vm.installmentTab === 'dp30' || vm.installmentTab === 'dp50') && vm.increaseInfo()" class="font-semibold">
            ₱ {{ (vm.increaseInfo().labNew || 0) | number:2 }}
          </div>
          <div ng-if="vm.installmentTab === 'standard'" class="font-semibold">
            ₱ {{ (vm.tuition.summary.lab_total || 0) | number:2 }}
          </div>
          
        </div>
        <div class="bg-gray-50 border rounded p-3">
          <div class="text-gray-500 uppercase text-xs">Additional</div>
          <div class="font-semibold">₱ {{ (vm.tuition.summary.additional_total || 0) | number:2 }}</div>
        </div>
        <div class="bg-gray-50 border rounded p-3">
          <div class="text-gray-500 uppercase text-xs">Scholarships</div>
          <div class="font-semibold text-green-700">₱ {{ (vm.tuition.summary.scholarships_total || 0) | number:2 }}</div>
        </div>
        <div class="bg-gray-50 border rounded p-3">
          <div class="text-gray-500 uppercase text-xs">Discounts</div>
          <div class="font-semibold text-green-700">₱ {{ (vm.tuition.summary.discounts_total || 0) | number:2 }}</div>
        </div>
        <div class="bg-gray-100 border rounded p-3 md:col-span-2">
          <div class="text-gray-500 uppercase text-xs">Total Due</div>
          <div class="font-semibold text-indigo-700 text-lg">₱ {{ (vm.displayedTotalDue() || 0) | number:2 }}</div>
        </div>
      </div>

      <!-- Tuition Items -->
      <div ng-if="vm.tuition.items && vm.tuition.items.tuition && vm.tuition.items.tuition.length">
        <h3 class="font-semibold">Tuition Items</h3>
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-4">Code</th>
              <th class="py-2 pr-4">Units</th>
              <th class="py-2 pr-4">Rate</th>
              <th class="py-2 pr-4">Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="t in vm.tuition.items.tuition" class="border-b">
              <td class="py-2 pr-4 font-mono">{{t.code || '—'}}</td>
              <td class="py-2 pr-4">{{t.units || 0}}</td>
              <td class="py-2 pr-4">₱ {{ (t.rate || 0) | number:2 }}</td>
              <td class="py-2 pr-4">₱ {{ (t.amount || 0) | number:2 }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Misc Items -->
      <div ng-if="vm.tuition.items && vm.tuition.items.misc && vm.tuition.items.misc.length">
        <h3 class="font-semibold">Misc Fees</h3>
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-4">Name</th>
              <th class="py-2 pr-4">Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="m in vm.tuition.items.misc" class="border-b">
              <td class="py-2 pr-4">{{m.name || '—'}}</td>
              <td class="py-2 pr-4">₱ {{ (m.amount || 0) | number:2 }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Lab Items -->
      <div ng-if="vm.tuition.items && vm.tuition.items.lab && vm.tuition.items.lab.length">
        <h3 class="font-semibold">Lab Fees</h3>
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-4">Subject Code</th>
              <th class="py-2 pr-4">Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="l in vm.tuition.items.lab" class="border-b">
              <td class="py-2 pr-4 font-mono">{{l.code || '—'}}</td>
              <td class="py-2 pr-4">₱ {{ (l.amount || 0) | number:2 }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Scholarships and Discounts -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div ng-if="vm.tuition.items && vm.tuition.items.scholarships && vm.tuition.items.scholarships.length">
          <h3 class="font-semibold">Scholarships</h3>
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b">
                <th class="py-2 pr-4">Name</th>
                <th class="py-2 pr-4">Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="s in vm.tuition.items.scholarships" class="border-b">
                <td class="py-2 pr-4">{{s.name || '—'}}</td>
                <td class="py-2 pr-4 text-green-700">₱ {{ (s.amount || 0) | number:2 }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div ng-if="vm.tuition.items && vm.tuition.items.discounts && vm.tuition.items.discounts.length">
          <h3 class="font-semibold">Discounts</h3>
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b">
                <th class="py-2 pr-4">Name</th>
                <th class="py-2 pr-4">Percent</th>
                <th class="py-2 pr-4">Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="d in vm.tuition.items.discounts" class="border-b">
                <td class="py-2 pr-4">{{d.name || '—'}}</td>
                <td class="py-2 pr-4">{{d.percent != null ? (d.percent + '%') : '—'}}</td>
                <td class="py-2 pr-4 text-green-700">₱ {{ (d.amount || 0) | number:2 }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Additional Items -->
      <div ng-if="vm.tuition.items && vm.tuition.items.additional && vm.tuition.items.additional.length">
        <h3 class="font-semibold">Additional Charges</h3>
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-4">Name</th>
              <th class="py-2 pr-4">Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="a in vm.tuition.items.additional" class="border-b">
              <td class="py-2 pr-4">{{a.name || '—'}}</td>
              <td class="py-2 pr-4">₱ {{ (a.amount || 0) | number:2 }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Queue operations -->
  <div class="bg-white border rounded p-4 space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Queue Operations</h2>
      <button class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              ng-click="vm.autoQueueFromChecklist()">
        Auto-Queue from Checklist
      </button>
    </div>

    <!-- Add -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">Add: Select Classlist</label>
        <select ng-model="vm.selectedAddClasslistId"
                ng-options="s.intID as s.display for s in vm.filteredSections()"
                class="mt-1 block w-full border rounded px-3 py-2">
          <option value="">-- Choose Classlist --</option>
        </select>
      </div>
      <div>
        <button class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                ng-click="vm.queueAdd()">
          Queue Add
        </button>
      </div>
    </div>

    <!-- Drop -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">Drop: Select Current Classlist</label>
        <select ng-model="vm.selectedDropClasslistId"
                ng-options="c.classlist_id as (c.code + ' — ' + c.description) for c in vm.filteredCurrent()"
                class="mt-1 block w-full border rounded px-3 py-2">
          <option value="">-- Choose Current Classlist --</option>
        </select>
      </div>
      <div>
        <button class="w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                ng-click="vm.queueDrop()">
          Queue Drop
        </button>
      </div>
    </div>

    <!-- Change Section -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">Change From (Current)</label>
        <select ng-model="vm.changeFromId"
                ng-options="c.classlist_id as (c.code + ' — ' + c.description) for c in vm.filteredCurrent()"
                class="mt-1 block w-full border rounded px-3 py-2">
          <option value="">-- Choose From --</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">Change To (Target)</label>
        <select ng-model="vm.changeToId"
                ng-options="s.intID as s.display for s in vm.filteredSections()"
                class="mt-1 block w-full border rounded px-3 py-2">
          <option value="">-- Choose To --</option>
        </select>
      </div>
      <div>
        <button class="w-full px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
                ng-click="vm.queueChange()">
          Queue Change
        </button>
      </div>
    </div>

    <!-- Pending ops -->
    <div class="mt-4">
      <h3 class="font-semibold mb-2">Pending Operations</h3>
      <div ng-if="!vm.ops.length" class="text-gray-500">No operations queued.</div>
      <ul class="space-y-2" ng-if="vm.ops.length">
        <li class="border rounded px-3 py-2" ng-repeat="op in vm.ops track by $index">
          <div class="flex items-center justify-between">
            <div class="font-mono text-sm">
              <span class="uppercase text-gray-600">{{op.type}}</span>
              <span ng-if="op.classlist_id"> — classlist_id={{op.classlist_id}}</span>
              <span ng-if="op.subjectCode"> — {{op.subjectCode}} <span ng-if="op.sectionCode">({{op.sectionCode}})</span></span>
              <span ng-if="op.from_classlist_id"> — from={{op.from_classlist_id}}</span>
              <span ng-if="op.to_classlist_id"> — to={{op.to_classlist_id}}</span>
              <span ng-if="op.fromSubjectCode || op.toSubjectCode">
                — from: {{op.fromSubjectCode}} <span ng-if="op.fromSectionCode">({{op.fromSectionCode}})</span>
                → to: {{op.toSubjectCode}} <span ng-if="op.toSectionCode">({{op.toSectionCode}})</span>
              </span>
            </div>
            <button class="px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300" ng-click="vm.removeOpAt($index)">
              Remove
            </button>
          </div>
          
          <!-- Prerequisite information for add operations -->
          <div ng-if="op.type === 'add' && op.prerequisite_check" class="mt-2 text-xs">
            <div ng-if="op.prerequisite_check.passed" class="text-green-600">
              <i class="fas fa-check-circle"></i> Prerequisites satisfied
            </div>
            <div ng-if="!op.prerequisite_check.passed" class="text-orange-600">
              <i class="fas fa-exclamation-triangle"></i> Prerequisites not satisfied
              <div class="mt-1">
                <span class="font-semibold">Missing:</span>
                <span ng-repeat="prereq in op.prerequisite_check.missing_prerequisites">
                  {{prereq.code}}<span ng-if="!$last">, </span>
                </span>
              </div>
            </div>
            <div ng-if="op.prerequisite_check.all_prerequisites.length > 0" class="mt-1 text-gray-500">
              <span class="font-semibold">All Prerequisites:</span>
              <span ng-repeat="prereq in op.prerequisite_check.all_prerequisites">
                {{prereq.code}}<span ng-if="!$last">, </span>
              </span>
            </div>
          </div>
        </li>
      </ul>
      <div class="mt-3 flex gap-2" ng-if="vm.ops.length">
        <button class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700" ng-click="vm.clearOps()">Clear</button>
        <button class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" ng-click="vm.submit()">Submit</button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="bg-white border rounded p-4" ng-if="vm.results">
    <h2 class="text-lg font-semibold mb-3">Results</h2>
    <div class="text-sm mb-2">
      <span class="font-semibold">Success:</span> {{vm.results.success}} —
      <span class="font-semibold">Message:</span> {{vm.results.message}}
    </div>
    <div class="mb-3">
      <h3 class="font-semibold">Operations</h3>
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-2 pr-4">Type</th>
            <th class="py-2 pr-4">OK</th>
            <th class="py-2 pr-4">Message</th>
            <th class="py-2 pr-4">Details</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="r in vm.results.operations" class="border-b">
            <td class="py-2 pr-4">{{r.type}}</td>
            <td class="py-2 pr-4">{{r.ok}}</td>
            <td class="py-2 pr-4">{{r.message}}</td>
            <td class="py-2 pr-4">
              <pre class="text-xs bg-gray-50 p-2 rounded">{{r.details | json}}</pre>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div>
      <h3 class="font-semibold">Current After Operations</h3>
      <table class="min-w-full text-sm" ng-if="vm.results.current.length">
        <thead>
          <tr class="text-left border-b">
            <th class="py-2 pr-4">Code</th>
            <th class="py-2 pr-4">Description</th>
            <th class="py-2 pr-4">Units</th>
            <th class="py-2 pr-4">Classlist ID</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="c in vm.results.current" class="border-b">
            <td class="py-2 pr-4 font-mono">{{c.code}}</td>
            <td class="py-2 pr-4">{{c.description}}</td>
            <td class="py-2 pr-4">{{c.units}}</td>
            <td class="py-2 pr-4 font-mono">{{c.classlist_id}}</td>
          </tr>
        </tbody>
      </table>
      <div ng-if="!vm.results.current.length" class="text-gray-500">No current enlisted after operations.</div>
    </div>
  </div>
</div>
