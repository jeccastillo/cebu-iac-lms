<div class="space-y-6" ng-controller="ClasslistViewerController as vm">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-800">
        Classlist Viewer
        <span class="text-sm text-gray-500 ml-2">#{{ vm.classlist.id }}</span>
      </h1>
      <div class="text-sm text-gray-600 mt-1">
        <span class="mr-2">Subject: <strong>{{ vm.classlist.subject_code || '-' }}</strong> — {{ vm.classlist.subject_description || '-' }}</span>
        <span class="ml-2">Term ID: <strong>{{ vm.classlist.strAcademicYear }}</strong></span>
      </div>
      <div class="mt-2 space-x-2">
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs"
              ng-class="{
                'bg-gray-100 text-gray-800': vm.classlist.intFinalized == 0,
                'bg-yellow-100 text-yellow-800': vm.classlist.intFinalized == 1,
                'bg-green-100 text-green-800': vm.classlist.intFinalized == 2
              }">
          Finalized: {{ vm.classlist.intFinalized }}
        </span>
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs"
              ng-class="vm.window && vm.window.midterm_active ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'">
          Midterm Window: {{ vm.window && vm.window.midterm_active ? 'Active' : 'Inactive' }}
        </span>
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs"
              ng-class="vm.window && vm.window.final_active ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'">
          Finals Window: {{ vm.window && vm.window.final_active ? 'Active' : 'Inactive' }}
        </span>
      </div>
    </div>
    <div class="flex items-center space-x-2">
      <a class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700"
         ng-href="#/classlists/{{ vm.id }}/attendance">
        <span class="fas fa-user-check mr-1"></span> Attendance
      </a>
      <button class="px-3 py-2 rounded bg-gray-100 text-gray-800 hover:bg-gray-200" ng-click="vm.back()">
        <span class="fas fa-arrow-left mr-1"></span> Back
      </button>
    </div>
  </div>

  <!-- Period and actions -->
  <div class="bg-white p-4 rounded shadow border border-gray-200 flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <label class="text-sm font-medium text-gray-700">Active Period:</label>
      <span class="inline-flex items-center px-2 py-1 rounded text-sm"
            ng-class="vm.period === 'midterm' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'">
        {{ vm.period | uppercase }}
      </span>
      <span class="text-xs text-gray-500 ml-2">Derived from submission status (0 → Midterm, ≥1 → Finals)</span>
    </div>
    <div class="flex items-center space-x-2">
      <button class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
              ng-disabled="!vm.permissions.can_edit || vm.loading"
              ng-click="vm.save()">
        <span class="fas fa-save mr-1"></span> Save Grades
      </button>
      <button class="px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50"
              ng-disabled="!vm.permissions.can_finalize || vm.loading || vm.hasIncompleteGrades()"
              ng-click="vm.finalize()">
        <span class="fas fa-check mr-1"></span> Finalize {{ vm.period | uppercase }}
      </button>
      <button class="px-3 py-2 rounded bg-red-600 text-white hover:bg-red-700 disabled:opacity-50"
              ng-disabled="!vm.permissions.can_unfinalize || vm.classlist.intFinalized === 0 || vm.loading"
              ng-click="vm.unfinalize()">
        <span class="fas fa-undo mr-1"></span> Unfinalize
      </button>
    </div>
  </div>

  <!-- Excel Import/Export controls -->
  <div class="bg-white p-4 rounded shadow border border-gray-200 mt-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <span class="text-sm font-medium text-gray-700">Excel Templates:</span>
        <button class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50"
                ng-disabled="vm.loading"
                ng-click="vm.downloadTemplate('midterm')">
          <span class="fas fa-file-excel mr-1"></span> Download Midterm Template
        </button>
        <button class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50"
                ng-disabled="vm.loading"
                ng-click="vm.downloadTemplate('finals')">
          <span class="fas fa-file-excel mr-1"></span> Download Finals Template
        </button>
      </div>
      <div class="flex items-center space-x-2">
        <span class="text-xs text-gray-600 mr-2">Upload applies to active period: <strong>{{ vm.period | uppercase }}</strong></span>
        <input id="gradesUploadInput"
               type="file"
               accept=".xlsx"
               class="text-sm"
               onchange="angular.element(this).scope().vm._onFileChange(event)" />
        <button class="px-3 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 disabled:opacity-50"
                ng-disabled="!vm.permissions.can_edit || vm.loading"
                ng-click="vm.upload(vm.period)">
          <span class="fas fa-upload mr-1"></span> Upload Grades
        </button>
      </div>
    </div>
  </div>

  <!-- Alerts -->
  <div ng-if="vm.error" class="rounded border border-red-200 bg-red-50 text-red-800 px-4 py-3">
    <span class="fas fa-exclamation-triangle mr-2"></span> {{ vm.error }}
  </div>
  <div ng-if="vm.success" class="rounded border border-green-200 bg-green-50 text-green-800 px-4 py-3">
    <span class="fas fa-check mr-2"></span> {{ vm.success }}
  </div>

  <!-- Grades Table -->
  <div class="bg-white rounded shadow border border-gray-200 overflow-x-auto" ng-class="{ 'opacity-50': vm.loading }">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr class="text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
          <th class="px-4 py-3">Student No.</th>
          <th class="px-4 py-3">Name</th>
          <th class="px-4 py-3">Midterm</th>
          <th class="px-4 py-3">Finals</th>
          <th class="px-4 py-3">Final Grade</th>
          <th class="px-4 py-3">Remarks</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
        <tr ng-repeat="s in vm.students">
          <td class="px-4 py-2 text-sm text-gray-800">{{ s.strStudentNumber || s.intStudentID }}</td>
          <td class="px-4 py-2 text-sm text-gray-800">
            {{ (s.strLastname || '') + (s.strFirstname ? (s.strLastname ? ', ' : '') + s.strFirstname : '') }}
          </td>
          <!-- Midterm column -->
          <td class="px-4 py-2 text-sm text-gray-800">
            <div ng-if="vm.options.midterm.mode === 'system'">
              <select class="w-40 border rounded px-2 py-1"
                      ng-disabled="vm.period !== 'midterm' || !vm.permissions.can_edit"
                      ng-model="vm.edits[s.intCSID].midterm"
                      ng-options="it.value as it.value for it in vm.options.midterm.items">
                <option value="">NGS</option>
              </select>
            </div>
            <div ng-if="vm.options.midterm.mode !== 'system'">
              <input type="number" class="w-28 border rounded px-2 py-1"
                     min="{{ vm.options.midterm.min || 1 }}" max="{{ vm.options.midterm.max || 100 }}"
                     ng-disabled="vm.period !== 'midterm' || !vm.permissions.can_edit"
                     ng-model="vm.edits[s.intCSID].midterm" placeholder="NGS" />
            </div>
          </td>
          <!-- Finals column -->
          <td class="px-4 py-2 text-sm text-gray-800">
            <div ng-if="vm.options.finals.mode === 'system'">
              <select class="w-40 border rounded px-2 py-1"
                      ng-disabled="vm.period !== 'finals' || !vm.permissions.can_edit"
                      ng-model="vm.edits[s.intCSID].finals"
                      ng-options="it.value as it.value for it in vm.options.finals.items">
                <option value="">NGS</option>
              </select>
            </div>
            <div ng-if="vm.options.finals.mode !== 'system'">
              <input type="number" class="w-28 border rounded px-2 py-1"
                     min="{{ vm.options.finals.min || 1 }}" max="{{ vm.options.finals.max || 100 }}"
                     ng-disabled="vm.period !== 'finals' || !vm.permissions.can_edit"
                     ng-model="vm.edits[s.intCSID].finals" placeholder="NGS" />
            </div>
          </td>
          <td class="px-4 py-2 text-sm text-gray-800">{{ s.floatFinalGrade || '-' }}</td>
          <td class="px-4 py-2 text-sm text-gray-800">{{ s.strRemarks || '-' }}</td>
        </tr>
        <tr ng-if="!vm.loading && (!vm.students || vm.students.length === 0)">
          <td colspan="6" class="px-4 py-6 text-center text-sm text-gray-500">
            No students found for this classlist.
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
