<div class="container-fluid" ng-controller="ClinicController as vm">
  <div class="page-header">
    <h2>Clinic &amp; Health Records</h2>
  </div>

  <div class="alert alert-danger" ng-if="vm.error">
    {{ vm.error }}
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">
      <strong>Search Filters</strong>
    </div>
    <div class="panel-body">
      <form class="form-horizontal" ng-submit="vm.search(1)">
        <div class="row">
          <div class="col-sm-3">
            <div class="form-group">
              <label class="control-label col-sm-4">Query</label>
              <div class="col-sm-8">
                <input type="text" class="form-control" ng-model="vm.filters.q" placeholder="Name, diagnosis, medication, allergy..." />
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label class="control-label col-sm-5">Student #</label>
              <div class="col-sm-7">
                <input type="text" class="form-control" ng-model="vm.filters.student_number" />
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label class="control-label col-sm-5">Faculty ID</label>
              <div class="col-sm-7">
                <input type="text" class="form-control" ng-model="vm.filters.faculty_id" />
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label class="control-label col-sm-5">Campus</label>
              <div class="col-sm-7">
                <input type="number" class="form-control" ng-model="vm.filters.campus_id" />
              </div>
            </div>
          </div>
        </div><!-- row -->

        <div class="row">
          <div class="col-sm-3">
            <div class="form-group">
              <label class="control-label col-sm-4">Program</label>
              <div class="col-sm-8">
                <input type="number" class="form-control" ng-model="vm.filters.program_id" />
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label class="control-label col-sm-5">Year Level</label>
              <div class="col-sm-7">
                <input type="number" class="form-control" ng-model="vm.filters.year_level" />
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label class="control-label col-sm-5">Date From</label>
              <div class="col-sm-7">
                <input type="date" class="form-control" ng-model="vm.filters.date_from" />
              </div>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-group">
              <label class="control-label col-sm-5">Date To</label>
              <div class="col-sm-7">
                <input type="date" class="form-control" ng-model="vm.filters.date_to" />
              </div>
            </div>
          </div>
        </div><!-- row -->

        <div class="row">
          <div class="col-sm-12 text-right">
            <button type="button" class="btn btn-default" ng-click="vm.clearFilters()" ng-disabled="vm.loading">Clear</button>
            <button type="submit" class="btn btn-primary" ng-disabled="vm.loading">
              <span ng-if="!vm.loading">Search</span>
              <span ng-if="vm.loading">
                <img src="assets/img/ajax-loader.gif" alt="" style="height:14px"> Searching...
              </span>
            </button>
          </div>
        </div>
      </form>
    </div><!-- panel-body -->
  </div><!-- panel -->

  <div class="panel panel-default">
    <div class="panel-heading">
      <strong>Results</strong>
      <span class="text-muted" ng-if="vm.meta && vm.meta.total"> ({{ vm.meta.total | number }} records)</span>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th style="width: 80px;">ID</th>
            <th>Person</th>
            <th>Type</th>
            <th>Campus</th>
            <th>Blood Type</th>
            <th>Allergies</th>
            <th>Medications</th>
            <th style="width: 120px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="r in vm.records">
            <td>{{ r.id }}</td>
            <td>
              <div ng-if="r.person_type === 'student'">
                <div><strong>{{ r.student_name || '-' }}</strong></div>
                <div class="text-muted">Student #: {{ r.student_number || '-' }}</div>
              </div>
              <div ng-if="r.person_type === 'faculty'">
                <div><strong>{{ r.faculty_name || '-' }}</strong></div>
                <div class="text-muted">Faculty ID: {{ r.faculty_id || '-' }}</div>
              </div>
            </td>
            <td>{{ r.person_type }}</td>
            <td>{{ r.campus_id || '-' }}</td>
            <td>{{ r.blood_type || '-' }}</td>
            <td>
              <span ng-repeat="a in (r.allergies || []) track by $index" class="label label-danger" style="margin-right:4px">
                {{ a.name }}
              </span>
              <span ng-if="!(r.allergies || []).length" class="text-muted">—</span>
            </td>
            <td>
              <span ng-repeat="m in (r.medications || []) track by $index" class="label label-info" style="margin-right:4px">
                {{ m.name }}
              </span>
              <span ng-if="!(r.medications || []).length" class="text-muted">—</span>
            </td>
            <td>
              <button class="btn btn-xs btn-primary" ng-click="vm.viewRecord(r)">View</button>
            </td>
          </tr>
          <tr ng-if="!vm.loading && (!vm.records || !vm.records.length)">
            <td colspan="8" class="text-center text-muted">No records found.</td>
          </tr>
          <tr ng-if="vm.loading">
            <td colspan="8" class="text-center">
              <img src="assets/img/ajax-loader.gif" alt="" style="height:18px"> Loading...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="panel-footer" ng-if="vm.meta && vm.meta.last_page > 1">
      <ul class="pagination pagination-sm" style="margin:0;">
        <li ng-class="{disabled: vm.meta.page <= 1}">
          <a href="" ng-click="vm.gotoPage(vm.meta.page - 1)">«</a>
        </li>
        <li class="active"><span>Page {{ vm.meta.page }} / {{ vm.meta.last_page }}</span></li>
        <li ng-class="{disabled: vm.meta.page >= vm.meta.last_page}">
          <a href="" ng-click="vm.gotoPage(vm.meta.page + 1)">»</a>
        </li>
      </ul>
    </div>
  </div>
</div>
