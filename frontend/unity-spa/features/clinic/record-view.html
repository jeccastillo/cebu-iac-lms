<div class="container-fluid" ng-controller="ClinicRecordViewController as vm">
  <div class="page-header">
    <h2>Health Record
      <small ng-if="vm.record && vm.record.person_type === 'student'">
        — {{ vm.record.student_name || 'Student' }} ({{ vm.record.student_number || '-' }})
      </small>
      <small ng-if="vm.record && vm.record.person_type === 'faculty'">
        — {{ vm.record.faculty_name || 'Faculty' }} (ID: {{ vm.record.faculty_id || '-' }})
      </small>
    </h2>
  </div>

  <div class="alert alert-danger" ng-if="vm.error">
    {{ vm.error }}
  </div>

  <div ng-if="vm.loading" class="text-center" style="padding: 12px;">
    <img src="assets/img/ajax-loader.gif" alt="" style="height:18px"> Loading record...
  </div>

  <div ng-if="vm.record">
    <div class="row">
      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading"><strong>Demographics</strong></div>
          <div class="panel-body">
            <div class="row">
              <div class="col-xs-6">
                <div><strong>Type:</strong> {{ vm.record.person_type }}</div>
                <div><strong>Campus ID:</strong> {{ vm.record.campus_id || '-' }}</div>
              </div>
              <div class="col-xs-6">
                <div><strong>Blood Type:</strong> {{ vm.record.blood_type || '-' }}</div>
                <div><strong>Updated By (ID):</strong> {{ vm.record.last_updated_by || '-' }}</div>
              </div>
            </div>
            <div class="row" style="margin-top: 8px;">
              <div class="col-xs-6">
                <div><strong>Height (cm):</strong> {{ vm.record.height_cm || '-' }}</div>
              </div>
              <div class="col-xs-6">
                <div><strong>Weight (kg):</strong> {{ vm.record.weight_kg || '-' }}</div>
              </div>
            </div>
            <div class="row" style="margin-top: 8px;">
              <div class="col-xs-12">
                <div><strong>Notes:</strong></div>
                <div class="well well-sm" style="margin-bottom: 0;" ng-bind="vm.record.notes || '—'"></div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /col-sm-6 -->

      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading"><strong>Allergies</strong></div>
          <div class="panel-body">
            <div ng-if="!(vm.record.allergies || []).length" class="text-muted">No allergies recorded.</div>
            <ul class="list-unstyled" ng-if="(vm.record.allergies || []).length">
              <li ng-repeat="a in vm.record.allergies track by $index">
                <span class="label label-danger" style="margin-right: 6px;">{{ a.name }}</span>
                <span class="text-muted" ng-if="a.reaction">Reaction: {{ a.reaction }}</span>
                <span class="text-muted" ng-if="a.severity">| Severity: {{ a.severity }}</span>
              </li>
            </ul>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><strong>Medications</strong></div>
          <div class="panel-body">
            <div ng-if="!(vm.record.medications || []).length" class="text-muted">No medications recorded.</div>
            <ul class="list-unstyled" ng-if="(vm.record.medications || []).length">
              <li ng-repeat="m in vm.record.medications track by $index">
                <span class="label label-info" style="margin-right: 6px;">{{ m.name }}</span>
                <span class="text-muted" ng-if="m.dose">Dose: {{ m.dose }}</span>
                <span class="text-muted" ng-if="m.freq">| Freq: {{ m.freq }}</span>
                <span class="text-muted" ng-if="m.ongoing">| Ongoing</span>
              </li>
            </ul>
          </div>
        </div>
      </div><!-- /col-sm-6 -->
    </div><!-- /row -->

    <div class="row">
      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading"><strong>Immunizations</strong></div>
          <div class="panel-body">
            <div ng-if="!(vm.record.immunizations || []).length" class="text-muted">No immunizations recorded.</div>
            <ul class="list-unstyled" ng-if="(vm.record.immunizations || []).length">
              <li ng-repeat="i in vm.record.immunizations track by $index">
                <span class="label label-success" style="margin-right: 6px;">{{ i.name }}</span>
                <span class="text-muted" ng-if="i.date">Date: {{ i.date }}</span>
                <span class="text-muted" ng-if="i.lot">| Lot: {{ i.lot }}</span>
                <span class="text-muted" ng-if="i.site">| Site: {{ i.site }}</span>
              </li>
            </ul>
          </div>
        </div>
      </div><!-- /col-sm-6 -->

      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading"><strong>Conditions</strong></div>
          <div class="panel-body">
            <div ng-if="!(vm.record.conditions || []).length" class="text-muted">No conditions recorded.</div>
            <ul class="list-unstyled" ng-if="(vm.record.conditions || []).length">
              <li ng-repeat="c in vm.record.conditions track by $index">
                <span class="label label-default" style="margin-right: 6px;">{{ c.name }}</span>
                <span class="text-muted" ng-if="c.since">Since: {{ c.since }}</span>
                <span class="text-muted" ng-if="c.status">| Status: {{ c.status }}</span>
              </li>
            </ul>
          </div>
        </div>
      </div><!-- /col-sm-6 -->
    </div><!-- /row -->

    <!-- Visits -->
    <div class="panel panel-default">
      <div class="panel-heading">
        <strong>Clinic Visits</strong>
        <span class="text-muted" ng-if="vm.vmeta && vm.vmeta.total"> ({{ vm.vmeta.total | number }} visits)</span>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th style="width: 160px;">Visit Date</th>
              <th>Reason</th>
              <th>Assessment</th>
              <th>Diagnosis</th>
              <th>Treatment</th>
              <th>Medications Dispensed</th>
              <th style="width: 90px;">Attachments</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="v in vm.visits">
              <td>{{ v.visit_date || '-' }}</td>
              <td>{{ v.reason || '-' }}</td>
              <td>
                <span ng-if="v.assessment">{{ v.assessment | limitTo: 80 }}<span ng-if="(v.assessment || '').length > 80">…</span></span>
                <span ng-if="!v.assessment" class="text-muted">—</span>
              </td>
              <td>
                <span ng-if="(v.diagnosis_codes || []).length">
                  <span class="label label-default" ng-repeat="d in v.diagnosis_codes track by $index" style="margin-right: 4px;">{{ d }}</span>
                </span>
                <span ng-if="!(v.diagnosis_codes || []).length" class="text-muted">—</span>
              </td>
              <td>
                <span ng-if="v.treatment">{{ v.treatment | limitTo: 80 }}<span ng-if="(v.treatment || '').length > 80">…</span></span>
                <span ng-if="!v.treatment" class="text-muted">—</span>
              </td>
              <td>
                <span ng-if="(v.medications_dispensed || []).length">
                  <span class="label label-info" ng-repeat="m in v.medications_dispensed track by $index" style="margin-right: 4px;">{{ m.name }}</span>
                </span>
                <span ng-if="!(v.medications_dispensed || []).length" class="text-muted">—</span>
              </td>
              <td class="text-center">{{ v.attachments_count || 0 }}</td>
            </tr>
            <tr ng-if="!vm.visitsLoading && (!vm.visits || !vm.visits.length)">
              <td colspan="7" class="text-center text-muted">No visits found.</td>
            </tr>
            <tr ng-if="vm.visitsLoading">
              <td colspan="7" class="text-center">
                <img src="assets/img/ajax-loader.gif" alt="" style="height:18px"> Loading visits...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="panel-footer" ng-if="vm.vmeta && vm.vmeta.last_page > 1">
        <ul class="pagination pagination-sm" style="margin:0;">
          <li ng-class="{disabled: vm.vmeta.page <= 1}">
            <a href="" ng-click="vm.gotoVisitPage(vm.vmeta.page - 1)">«</a>
          </li>
          <li class="active"><span>Page {{ vm.vmeta.page }} / {{ vm.vmeta.last_page }}</span></li>
          <li ng-class="{disabled: vm.vmeta.page >= vm.vmeta.last_page}">
            <a href="" ng-click="vm.gotoVisitPage(vm.vmeta.page + 1)">»</a>
          </li>
        </ul>
      </div>
      <div class="alert alert-danger" ng-if="vm.visitsError" style="margin: 10px;">
        {{ vm.visitsError }}
      </div>
    </div>

  </div><!-- /vm.record -->
</div>
