<div class="mx-auto px-4 py-6" ng-cloak>
  <div class="bg-white rounded shadow border border-gray-200 p-5 max-w-5xl mx-auto">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Admin: Edit Student</h2>

    <!-- Alerts -->
    <div class="rounded border border-yellow-200 bg-yellow-50 px-4 py-3 text-yellow-700 mb-3" ng-if="!vm.hasAdmin()">
      Admin role required. Redirecting to login...
    </div>

    <div class="rounded border border-blue-200 bg-blue-50 px-4 py-3 text-blue-700 mb-3" ng-if="vm.loading.init">
      Loading student data...
    </div>

    <div class="rounded border border-red-200 bg-red-50 px-4 py-3 text-red-700 mb-3" ng-if="vm.error.init">
      {{ vm.error.init }}
    </div>

    <div ng-if="!vm.loading.init && vm.hasAdmin()">

      <!-- Actions (header) -->
      <div class="flex items-center space-x-2 mb-4">
        <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60"
                ng-click="vm.save()" ng-disabled="vm.loading.save">
          <span ng-if="!vm.loading.save">Save</span>
          <span ng-if="vm.loading.save">Saving...</span>
        </button>
        <button class="px-4 py-2 rounded bg-gray-100 text-gray-800 hover:bg-gray-200"
                ng-click="vm.reset()" ng-disabled="vm.loading.save">
          Reset
        </button>
        <button class="px-4 py-2 rounded text-blue-600 hover:underline"
                ng-click="vm.backToViewer()">
          Back to Student Viewer
        </button>
      </div>

      <!-- Save status alerts -->
      <div class="rounded border border-emerald-200 bg-emerald-50 px-4 py-3 text-emerald-700 mb-3" ng-if="vm.success.save">
        {{ vm.success.save }}
      </div>
      <div class="rounded border border-red-200 bg-red-50 px-4 py-3 text-red-700 mb-3" ng-if="vm.error.save">
        {{ vm.error.save }}
      </div>

      <!-- Form -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Left column -->
        <div class="space-y-6">
          <!-- Identity -->
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Identity</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">intID (immutable)</label>
                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50 text-gray-700"
                       ng-model="vm.model.intID" disabled />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Student Number (strStudentNumber)</label>
                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.strStudentNumber" placeholder="e.g., 2023-00001" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">First Name (strFirstname)</label>
                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.strFirstname" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Middle Name (strMiddlename)</label>
                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.strMiddlename" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Last Name (strLastname)</label>
                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.strLastname" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Gender (enumGender)</label>
                <select class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        ng-model="vm.model.enumGender">
                  <option value="">-- unset --</option>
                  <option value="male">male</option>
                  <option value="female">female</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Birth Date (dteBirthDate)</label>
                <input type="date" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.dteBirthDate" />
              </div>
            </div>
          </div>

          <!-- Contact -->
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Contact</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email (strEmail)</label>
                <input type="email" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.strEmail" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">GSuite Email (strGSuiteEmail)</label>
                <input type="email" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.strGSuiteEmail" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number (strMobileNumber)</label>
                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.strMobileNumber" />
              </div>
            </div>
          </div>

          <!-- Status -->
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Status</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Student Status (student_status)</label>
                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.student_status" placeholder="active | inactive | loa | awol | applicant" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Student Type (student_type)</label>
                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.student_type" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Level (level)</label>
                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model.level" />
              </div>
            </div>
          </div>
        </div>

        <!-- Right column -->
        <div class="space-y-6">
          <!-- Program & Campus -->
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Program &amp; Campus</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Program (intProgramID)</label>
                <select class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        ng-model="vm.model.intProgramID"
                        ng-options="(p.intProgramID + '') as ((p.strProgramCode || p.code) ? ((p.strProgramCode || p.code) + ' â€” ' + (p.strProgramDescription || p.title || p.description || '')) : (p.strProgramDescription || p.title || p.description || ('Program #' + (p.intProgramID || p.id || '')))) for p in vm.programs track by p.intProgramID">
                  <option value="">-- select program --</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Campus (campus_id)</label>
                <select class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        ng-model="vm.model.campus_id"
                        ng-options="(c.id + '') as c.campus_name for c in vm.campuses track by c.id">
                  <option value="">-- select campus --</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Other Fields (dynamic) -->
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Other Fields (dynamic)</h3>
            <p class="text-sm text-gray-600 mb-2">
              These fields are present on this installation of tb_mas_users and are editable.
            </p>
            <div class="space-y-3" ng-repeat="key in vm.dynamicKeys">
              <div ng-if="key !== 'intID'">
                <label class="block text-sm font-medium text-gray-700 mb-1">{{ key }}</label>
                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       ng-model="vm.model[key]" />
              </div>
            </div>
          </div>

          <!-- Advanced JSON Editor -->
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Advanced JSON Editor</h3>
            <p class="text-sm text-gray-600 mb-2">
              Edit raw fields as JSON (key-value). intID will be ignored if provided here. Invalid JSON prevents saving.
            </p>
            <textarea class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      rows="12" ng-model="vm.advancedJson" spellcheck="false"></textarea>
            <div class="text-sm text-gray-600 mt-2">
              <div>Tips:</div>
              <ul class="list-disc list-inside">
                <li>Leave fields blank to set to null on save.</li>
                <li>Only keys that exist in tb_mas_users will be updated.</li>
              </ul>
            </div>
          </div>
        </div>

      </div>

      <!-- Actions (footer) -->
      <div class="flex items-center space-x-2 mt-6">
        <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60"
                ng-click="vm.save()" ng-disabled="vm.loading.save">
          <span ng-if="!vm.loading.save">Save</span>
          <span ng-if="vm.loading.save">Saving...</span>
        </button>
        <button class="px-4 py-2 rounded bg-gray-100 text-gray-800 hover:bg-gray-200"
                ng-click="vm.reset()" ng-disabled="vm.loading.save">
          Reset
        </button>
        <button class="px-4 py-2 rounded text-blue-600 hover:underline"
                ng-click="vm.backToViewer()">
          Back to Student Viewer
        </button>
      </div>
    </div>
  </div>
</div>
