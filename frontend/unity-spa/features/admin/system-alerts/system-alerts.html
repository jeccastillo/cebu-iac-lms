<div class="max-w-5xl mx-auto">
  <h1 class="text-2xl font-semibold text-gray-900 mb-6">System Alerts</h1>

  <!-- Notices -->
  <div ng-if="vm.notice" class="mb-4 p-3 rounded border border-green-200 bg-green-50 text-green-800">
    {{ vm.notice }}
  </div>
  <div ng-if="vm.error" class="mb-4 p-3 rounded border border-red-200 bg-red-50 text-red-800">
    {{ vm.error }}
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Create Alert -->
    <div class="bg-white rounded border border-gray-200 shadow-sm p-4">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">Create New Alert</h2>

      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Title (optional)</label>
          <input type="text"
                 class="w-full border rounded px-3 py-2"
                 ng-model="vm.form.title"
                 placeholder="e.g. Enrollment Notice" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Message</label>
          <textarea class="w-full border rounded px-3 py-2"
                    rows="4"
                    ng-model="vm.form.message"
                    placeholder="Message to display in the top alert bar"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Link (optional)</label>
          <input type="text"
                 class="w-full border rounded px-3 py-2"
                 ng-model="vm.form.link"
                 placeholder="Internal: /path or #/path, External: https://example.com" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
          <select class="w-full border rounded px-3 py-2" ng-model="vm.form.type"
                  ng-options="t for t in vm.types"></select>
        </div>

        <div class="flex items-center gap-2">
          <input id="target_all" type="checkbox" class="h-4 w-4"
                 ng-model="vm.form.target_all" />
          <label for="target_all" class="text-sm text-gray-700">Target all users (ignore role and campus filters)</label>
        </div>

        <!-- Role selection -->
        <div ng-if="!vm.form.target_all">
          <label class="block text-sm font-medium text-gray-700 mb-1">Target Roles (optional)</label>
          <div class="grid grid-cols-2 gap-2">
            <label ng-repeat="code in vm.availableRoles" class="inline-flex items-center gap-2">
              <input type="checkbox"
                     class="h-4 w-4"
                     ng-checked="vm.isRoleSelected(code)"
                     ng-click="vm.toggleRole(code)" />
              <span class="text-sm">{{ code }}</span>
            </label>
          </div>
        </div>

        <!-- Campus selection -->
        <div ng-if="!vm.form.target_all">
          <label class="block text-sm font-medium text-gray-700 mb-1">Target Campuses (optional)</label>
          <div class="grid grid-cols-2 gap-2">
            <label ng-repeat="c in vm.campuses" class="inline-flex items-center gap-2">
              <input type="checkbox"
                     class="h-4 w-4"
                     ng-checked="vm.isCampusSelected(c.id)"
                     ng-click="vm.toggleCampus(c.id)" />
              <span class="text-sm">{{ c.campus_name || ('Campus #' + c.id) }}</span>
            </label>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Starts At (optional)</label>
            <input type="datetime-local" class="w-full border rounded px-3 py-2"
                   ng-model="vm.form.starts_at" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ends At (optional)</label>
            <input type="datetime-local" class="w-full border rounded px-3 py-2"
                   ng-model="vm.form.ends_at" />
          </div>
        </div>

        <div class="flex items-center gap-4">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" class="h-4 w-4" ng-model="vm.form.intActive" ng-true-value="1" ng-false-value="0" />
            <span class="text-sm text-gray-700">Active</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" class="h-4 w-4" ng-model="vm.form.system_generated" ng-true-value="1" ng-false-value="0" />
            <span class="text-sm text-gray-700">System Generated</span>
          </label>
        </div>

        <div class="pt-2">
          <button type="button"
                  class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
                  ng-disabled="vm.loading"
                  ng-click="vm.submit()">
            {{ vm.loading ? 'Saving...' : 'Create Alert' }}
          </button>
          <button type="button"
                  class="ml-2 px-3 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50"
                  ng-disabled="vm.loading"
                  ng-click="vm.clearForm()">
            Clear
          </button>
        </div>
      </div>
    </div>

    <!-- Existing Alerts -->
    <div class="bg-white rounded border border-gray-200 shadow-sm p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800">Active Alerts</h2>
        <button class="text-sm text-gray-600 hover:text-gray-800"
                ng-click="vm.load()" ng-disabled="vm.loading">
          Refresh
        </button>
      </div>

      <div class="mt-3">
        <div ng-if="vm.loading" class="text-sm text-gray-500">Loading...</div>
        <div ng-if="!vm.loading && (!vm.rows || !vm.rows.length)" class="text-sm text-gray-500">
          No active alerts.
        </div>

        <div class="space-y-3" ng-if="!vm.loading && vm.rows && vm.rows.length">
          <div ng-repeat="row in vm.rows track by row.id"
               class="p-3 border rounded flex items-start justify-between"
               ng-class="{
                 'border-green-300 bg-green-50': row.type === 'success',
                 'border-yellow-300 bg-yellow-50': row.type === 'warning',
                 'border-red-300 bg-red-50': row.type === 'error',
                 'border-blue-300 bg-blue-50': !row.type || row.type === 'info',
                 'cursor-pointer hover:bg-gray-50': row.link
               }"
               ng-click="row.link && vm.open(row)">
            <div class="pr-4">
              <div class="font-semibold" ng-if="row.title" ng-bind="row.title"></div>
              <div class="text-sm" ng-bind="row.message"></div>
              <div class="mt-2 text-xs text-gray-600">
                <span class="inline-block mr-3">Type: <strong>{{ row.type || 'info' }}</strong></span>
                <span class="inline-block mr-3">Active: <strong>{{ row.intActive === 1 ? 'Yes' : 'No' }}</strong></span>
                <span class="inline-block mr-3" ng-if="row.target_all">Audience: <strong>All</strong></span>
                <span class="inline-block mr-3" ng-if="!row.target_all && row.role_codes && row.role_codes.length">
                  Roles: <strong>{{ row.role_codes.join(', ') }}</strong>
                </span>
                <span class="inline-block mr-3" ng-if="!row.target_all && row.campus_ids && row.campus_ids.length">
                  Campuses: <strong>{{ row.campus_ids.join(', ') }}</strong>
                </span>
                <span class="inline-block mr-3" ng-if="row.starts_at">Starts: <strong>{{ row.starts_at | date:'short' }}</strong></span>
                <span class="inline-block" ng-if="row.ends_at">Ends: <strong>{{ row.ends_at | date:'short' }}</strong></span>
                <span class="inline-block mr-3" ng-if="row.link">
                  Link: <span class="underline text-blue-600">{{ row.link }}</span>
                </span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button"
                      class="px-3 py-1.5 rounded border border-gray-300 text-gray-700 hover:bg-gray-50"
                      ng-disabled="vm.loading"
                      ng-click="vm.disable(row)">
                Disable
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
