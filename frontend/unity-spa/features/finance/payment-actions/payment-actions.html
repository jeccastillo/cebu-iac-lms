<div class="px-4 py-6">
  <h1 class="text-2xl font-semibold text-gray-900 mb-1">Payment Actions</h1>
  <p class="text-sm text-gray-600 mb-6">Finance Admin page to search payments by OR/Invoice and perform Void or Retract.</p>

  <!-- Access guard -->
  <div class="mb-4" ng-if="!vm.isFinanceAdmin">
    <div class="rounded border border-red-200 bg-red-50 px-4 py-3 text-red-700">
      Access denied. Finance Admin or Admin only.
    </div>
  </div>

  <!-- Alerts -->
  <div class="mb-4 space-y-2" ng-if="vm.isFinanceAdmin">
    <div class="rounded border border-emerald-200 bg-emerald-50 px-4 py-3 text-emerald-700" ng-if="vm.success">
      {{ vm.success }}
    </div>
    <div class="rounded border border-red-200 bg-red-50 px-4 py-3 text-red-700" ng-if="vm.error">
      {{ vm.error }}
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4" ng-if="vm.isFinanceAdmin">
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm text-gray-600 mb-1">OR Number</label>
        <input type="text" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter OR number"
               ng-model="vm.filters.or_number">
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Invoice Number</label>
        <input type="text" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter Invoice number"
               ng-model="vm.filters.invoice_number">
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Student Number (optional)</label>
        <input type="text" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g. C2023-01-082"
               ng-model="vm.filters.student_number">
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Term (SYID) (optional)</label>
        <input type="number" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g. 31"
               ng-model="vm.filters.syid">
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Status</label>
        <select class="w-full border border-gray-300 rounded-md px-3 py-2" ng-model="vm.filters.status">
          <option value="">Any</option>
          <option value="Paid">Paid</option>
          <option value="Void">Void</option>
          <option value="Pending">Pending</option>
          <option value="Cancelled">Cancelled</option>
          <option value="Error">Error</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Per Page</label>
        <select class="w-full border border-gray-300 rounded-md px-3 py-2" ng-model="vm.filters.per_page">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="flex items-end space-x-2">
        <button class="inline-flex items-center px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
                ng-click="vm.search(true)">
          Search
        </button>
        <button class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                ng-click="vm.resetFilters()">
          Reset
        </button>
      </div>
      <div class="text-xs text-gray-500 flex items-end">
        Tip: Enter OR and/or Invoice number. At least one is required to search.
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="mt-6" ng-if="vm.isFinanceAdmin">
    <div class="flex items-center justify-between mb-3">
      <div class="text-sm text-gray-600">
        <span class="font-medium text-gray-900">{{ vm.meta.total || 0 }}</span> results
        <span ng-if="vm.meta.total > 0"> â€¢ page {{ vm.meta.page || 1 }} of {{ Math.max(1, Math.ceil((vm.meta.total||0)/(vm.meta.per_page||20))) }}</span>
      </div>
      <div class="flex items-center space-x-2">
        <button class="px-3 py-1.5 rounded border border-gray-300 text-gray-700 hover:bg-gray-50"
                ng-click="vm.goPage(-1)" ng-disabled="(vm.meta.page||1) <= 1">Prev</button>
        <button class="px-3 py-1.5 rounded border border-gray-300 text-gray-700 hover:bg-gray-50"
                ng-click="vm.goPage(1)" ng-disabled="(vm.meta.page||1) >= Math.max(1, Math.ceil((vm.meta.total||0)/(vm.meta.per_page||20)))">Next</button>
      </div>
    </div>

    <div class="overflow-x-auto bg-white rounded-lg shadow-sm border border-gray-200">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr class="text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            <th class="px-3 py-2">ID</th>
            <th class="px-3 py-2">Posted</th>
            <th class="px-3 py-2">OR Date</th>
            <th class="px-3 py-2">OR</th>
            <th class="px-3 py-2">Invoice</th>
            <th class="px-3 py-2">Description</th>
            <th class="px-3 py-2">Amount</th>
            <th class="px-3 py-2">Total Due</th>
            <th class="px-3 py-2">Status</th>
            <th class="px-3 py-2">Method</th>
            <th class="px-3 py-2">Mode</th>
            <th class="px-3 py-2">Term</th>
            <th class="px-3 py-2"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100" ng-if="vm.items && vm.items.length">
          <tr class="hover:bg-gray-50" ng-repeat="p in vm.items">
            <td class="px-3 py-2 text-sm text-gray-900">{{ p.id }}</td>
            <td class="px-3 py-2 text-sm text-gray-700">{{ p.posted_at || '' }}</td>
            <td class="px-3 py-2 text-sm text-gray-700">{{ vm.dateOnly(p.posted_at) || '' }}</td>
            <td class="px-3 py-2 text-sm text-gray-700">{{ p.or_no || '' }}</td>
            <td class="px-3 py-2 text-sm text-gray-700">{{ p.invoice_number || '' }}</td>
            <td class="px-3 py-2 text-sm text-gray-700">{{ p.description || '' }}</td>
            <td class="px-3 py-2 text-sm text-gray-900">{{ p.subtotal_order != null ? (p.subtotal_order | number : 2) : '' }}</td>
            <td class="px-3 py-2 text-sm text-gray-900">{{ p.total_amount_due != null ? (p.total_amount_due | number : 2) : '' }}</td>
            <td class="px-3 py-2 text-sm">
              <span class="inline-flex items-center rounded px-2 py-0.5 text-xs"
                    ng-class="{
                      'bg-emerald-50 text-emerald-700 border border-emerald-200': p.status === 'Paid',
                      'bg-yellow-50 text-yellow-700 border border-yellow-200': p.status === 'Pending',
                      'bg-red-50 text-red-700 border border-red-200': p.status === 'Void' || p.status === 'Cancelled' || p.status === 'Error',
                      'bg-gray-50 text-gray-700 border border-gray-200': !p.status
                    }">{{ p.status || '-' }}</span>
            </td>
            <td class="px-3 py-2 text-sm text-gray-700">{{ p.method || '' }}</td>
            <td class="px-3 py-2 text-sm text-gray-700">{{ p.mode_of_payment_id || '' }}</td>
            <td class="px-3 py-2 text-sm text-gray-700">{{ p.sy_reference || '' }}</td>
            <td class="px-3 py-2 text-right space-x-2">
              <button class="inline-flex items-center px-3 py-1.5 rounded border border-yellow-300 text-yellow-800 hover:bg-yellow-50"
                      ng-click="vm.doVoid(p)">
                Void
              </button>
              <button class="inline-flex items-center px-3 py-1.5 rounded border border-red-300 text-red-700 hover:bg-red-50"
                      ng-click="vm.retract(p)">
                Retract
              </button>
            </td>
          </tr>
        </tbody>
        <tbody ng-if="!vm.items || !vm.items.length">
          <tr>
            <td class="px-3 py-6 text-center text-sm text-gray-500" colspan="13">
              <em>No results.</em>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="fixed inset-0 bg-white bg-opacity-50 z-30 flex items-center justify-center" ng-if="vm.loading">
    <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
  </div>
</div>
