<div class="p-4">
  <h1 class="text-2xl font-semibold text-gray-800 mb-4">Student Billing</h1>

  <!-- Filters -->
  <div class="bg-white border rounded p-4 mb-4">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">      
      <div>
        <label class="block text-sm text-gray-600 mb-1">Student (autocomplete)</label>
        <input type="text"
               class="w-full border rounded px-3 py-2"
               placeholder="Search student by name or number…"
               pui-autocomplete
               ng-model="vm.filters.student_id"
               pui-source="vm.students"
               pui-item-key="id"
               pui-label="(((item.student_number && item.student_number.length) ? item.student_number : ('ID:' + item.id)) + ' — ' + item.last_name + ', ' + item.first_name + (item.middle_name ? (' ' + item.middle_name) : ''))"
               pui-on-select="vm.onStudentSelect()"
               pui-on-query="vm.onStudentQuery($query)"
               pui-min-chars="1"
               pui-query-debounce="250"
               pui-max-results="20" />
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Term (SYID)</label>
        <input type="text"
               class="w-full border rounded px-3 py-2"
               placeholder="Search or select a term…"
               pui-autocomplete
               ng-model="vm.filters.term"
               pui-source="vm.termOptions"
               pui-item-key="intID"
               pui-label="(item.label || ('SY ' + item.intID))" />        
      </div>
      <div class="flex items-end gap-2 self-end h-full mb-1">        
        <button class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2"
                ng-click="vm.search()"
                ng-disabled="vm.loading">
          <span ng-if="!vm.loading">Search</span>
          <span ng-if="vm.loading">Loading...</span>
        </button>
        <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 rounded px-4 py-2"
                ng-click="vm.resetFilters()"
                ng-disabled="vm.loading">
          Reset
        </button>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm text-gray-600">
      Use positive amounts for additional charges and negative amounts for credits.
    </div>
    <button class="bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2"
            ng-click="vm.openAdd()">
      Add Billing Item
    </button>
  </div>

  <!-- Results Table -->
  <div class="bg-white border rounded">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 text-gray-700">
        <tr>
          <th class="text-left px-4 py-2 border-b">Description</th>
          <th class="text-right px-4 py-2 border-b">Amount</th>
          <th class="text-left px-4 py-2 border-b">Posted At</th>
          <th class="text-left px-4 py-2 border-b">Remarks</th>
          <th class="text-center px-4 py-2 border-b">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-if="!vm.items.length && !vm.loading">
          <td colspan="5" class="px-4 py-4 text-center text-gray-500">No records found.</td>
        </tr>
        <tr ng-repeat="it in vm.items" class="border-b hover:bg-gray-50">
          <td class="px-4 py-2">{{ it.description }}</td>
          <td class="px-4 py-2 text-right"
              ng-class="{'text-red-600': it.amount < 0, 'text-gray-900': it.amount >= 0}">
            ₱ {{ it.amount | number:2 }}
          </td>
          <td class="px-4 py-2">{{ it.posted_at || '—' }}</td>
          <td class="px-4 py-2">{{ it.remarks || '—' }}</td>
          <td class="px-4 py-2 text-center">
            <button class="text-blue-600 hover:underline mr-3" ng-click="vm.openEdit(it)">Edit</button>
            <button class="text-red-600 hover:underline" ng-click="vm.remove(it)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50" ng-if="vm.modalOpen">
    <div class="bg-white rounded shadow-xl w-full max-w-lg">
      <div class="border-b px-4 py-3 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800">
          {{ vm.editing ? 'Edit Billing Item' : 'Add Billing Item' }}
        </h2>
        <button class="text-gray-500 hover:text-gray-700" ng-click="vm.closeModal()">✕</button>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 gap-4">
          <div ng-if="!vm.editing">
            <label class="block text-sm text-gray-600 mb-1">Student</label>
            <div class="w-full border rounded px-3 py-2 bg-gray-50 text-gray-800">
              {{ vm.getStudentDisplay() }}
            </div>
          </div>
          <div ng-if="!vm.editing">
            <label class="block text-sm text-gray-600 mb-1">Term</label>
            <div class="w-full border rounded px-3 py-2 bg-gray-50 text-gray-800">
              {{ vm.getTermDisplay() }}
            </div>
          </div>
          <div ng-if="!vm.editing">
            <label class="block text-sm text-gray-600 mb-1">Description</label>
            <select class="w-full border rounded px-3 py-2"
                    ng-model="vm.current.payment_description_id"
                    ng-change="vm.onPaymentDescriptionChange()"
                    ng-options="d.intID as (d.name + (d.amount !== null && d.amount !== undefined ? (' — ₱ ' + (d.amount | number:2)) : '')) for d in vm.paymentDescriptions">
              <option value="">-- Select item --</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Selecting an item will fill in the description and default amount.</p>
          </div>
          <div ng-if="vm.editing">
            <label class="block text-sm text-gray-600 mb-1">Description</label>
            <input type="text"
                   class="w-full border rounded px-3 py-2"
                   ng-model="vm.current.description"
                   placeholder="Reason or item (e.g., ID Replacement)" />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Amount</label>
            <input type="number"
                   step="0.01"
                   class="w-full border rounded px-3 py-2"
                   ng-model="vm.current.amount"
                   placeholder="e.g., 500 or -250" />
            <p class="text-xs text-gray-500 mt-1">Use negative value for credits/refunds. Zero is not allowed.</p>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Posted At (optional)</label>
            <input type="datetime-local"
                   class="w-full border rounded px-3 py-2"
                   ng-model="vm.current.posted_at" />
          </div>
          <div ng-if="!vm.editing" class="flex items-center gap-2">
            <input type="checkbox"
                   id="sb-generate-invoice"
                   class="h-4 w-4"
                   ng-model="vm.current.generate_invoice" />
            <label for="sb-generate-invoice" class="text-sm text-gray-700 select-none">Generate invoice now</label>
          </div>
          <p ng-if="!vm.editing" class="text-xs text-gray-500 -mt-2 mb-2">
            Uncheck to add the billing entry without creating an invoice. You can generate one later from Cashier or Invoices.
          </p>

          <!-- Extra invoice fields shown only when generating an invoice now -->
          <div ng-if="!vm.editing &amp;&amp; vm.current.generate_invoice" class="grid grid-cols-1 md:grid-cols-2 gap-4 border rounded p-3 bg-gray-50">
            <div>
              <label class="block text-sm text-gray-600 mb-1">Less EWT (%)</label>
              <input type="number"
                     min="0"
                     max="100"
                     step="1"
                     class="w-full border rounded px-3 py-2"
                     ng-model="vm.current.withholding_tax_percentage"
                     placeholder="e.g., 1 or 2" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Vatable Amount</label>
              <input type="number"
                     step="0.01"
                     class="w-full border rounded px-3 py-2"
                     ng-model="vm.current.invoice_amount"
                     placeholder="e.g., 1000.00" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Vat Exempt Tax</label>
              <input type="number"
                     step="0.01"
                     class="w-full border rounded px-3 py-2"
                     ng-model="vm.current.invoice_amount_ves"
                     placeholder="e.g., 0.00" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Vat Zero Rated Sales</label>
              <input type="number"
                     step="0.01"
                     class="w-full border rounded px-3 py-2"
                     ng-model="vm.current.invoice_amount_vzrs"
                     placeholder="e.g., 0.00" />
            </div>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Remarks (optional)</label>
            <textarea class="w-full border rounded px-3 py-2"
                      rows="3"
                      ng-model="vm.current.remarks"
                      placeholder="Optional notes"></textarea>
          </div>
        </div>
      </div>
      <div class="border-t px-4 py-3 flex items-center justify-end gap-2">
        <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 rounded px-4 py-2" ng-click="vm.closeModal()">Cancel</button>
        <button class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2" ng-click="vm.save()">Save</button>
      </div>
    </div>
  </div>
</div>
