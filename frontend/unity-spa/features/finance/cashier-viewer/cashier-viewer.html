<div class="container mx-auto px-4" ng-cloak>
    <!-- Page header -->
    <div class="mb-4">
      <h2 class="mt-2 text-2xl font-semibold text-gray-900">
        Cashier
        <small class="ml-2 text-gray-500 align-middle" ng-if="vm.student">
          &mdash; {{ (vm.student.last_name || vm.student.strLastname) | uppercase }}, {{ (vm.student.first_name || vm.student.strFirstname) | uppercase }}
          <span ng-if="vm.student.strMiddlename"> {{ vm.student.strMiddlename | uppercase }}</span>
          &nbsp;[{{ vm.sn || (vm.student.student_number || vm.student.strStudentNumber) | uppercase }}]
        </small>
      </h2>
      <div class="border-t my-4"></div>
      <div class="text-sm text-gray-600 mt-2">
        <span ng-if="vm.termLabel">Term: <strong>{{ vm.termLabel }}</strong></span>
        <span ng-if="!vm.termLabel" class="text-gray-500">Select a term from the global selector.</span>
      </div>
    </div>
  
    <!-- Bootstrap status -->
    <div ng-if="vm.loading.bootstrap" class="mb-4">
      <div class="rounded border border-blue-200 bg-blue-50 text-blue-700 px-4 py-3">Loading data, please wait...</div>
    </div>
  
    <!-- Errors summary -->
    <div ng-if="vm.error.student || vm.error.registration || vm.error.tuition || vm.error.ledger || vm.error.records" class="mb-4">
      <div class="rounded border border-blue-200 bg-blue-50 text-blue-700 px-4 py-3 space-y-1">
        <div ng-if="vm.error.student">Student: {{ vm.error.student }}</div>
        <div ng-if="vm.error.registration">Registration: {{ vm.error.registration }}</div>
        <div ng-if="vm.error.tuition">Tuition: {{ vm.error.tuition }}</div>
        <div ng-if="vm.error.ledger">Ledger: {{ vm.error.ledger }}</div>
        <div ng-if="vm.error.records">Records: {{ vm.error.records }}</div>
      </div>
    </div>
  
    <!-- Controls -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Select Student</label>
        <input
          type="text"
          class="mt-1 block w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="Search or select a student..."
          pui-autocomplete
          ng-model="vm.selectedStudentId"
          pui-source="vm.students"
          pui-item-key="id"
          pui-label="(item.student_number + ' â€” ' + item.last_name + ', ' + item.first_name + (item.middle_name ? (' ' + item.middle_name) : ''))"
          pui-on-select="vm.onStudentSelected()"
          pui-min-chars="1"
          pui-query-debounce="250"
          pui-on-query="vm.onStudentQuery($query)"
        />
      </div>
      <div class="md:col-span-2 flex md:justify-end items-end">
        <a class="inline-flex items-center px-4 py-2 rounded border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 mt-2 md:mt-6"
           href="#/students/{{ vm.id }}?sn={{ vm.sn }}">
          Back to Student
        </a>
      </div>
    </div>
  
    <!-- Registration + Tuition -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Registration Card -->
      <div>
        <div class="border rounded-lg shadow-sm overflow-hidden">
          <div class="bg-blue-600 text-white px-4 py-2 flex items-center justify-between">
            <strong>Options</strong>
            <span class="text-sm opacity-90" ng-if="vm.loading.registration"><em>loading...</em></span>
          </div>
  
          <!-- No registration -->
          <div class="p-4 bg-white" ng-if="vm.registrationResp && vm.registrationResp.data && !vm.registrationResp.data.exists">
            <div class="m-0 rounded border border-yellow-200 bg-yellow-50 text-yellow-700 px-4 py-3">
              No registration found for the selected term.
            </div>
          </div>
  
          <!-- Registration form -->
          <div class="p-4 bg-white space-y-4" ng-if="vm.registration">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Payment Type</label>
                <select
                  class="block w-full rounded border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  ng-model="vm.edit.paymentType"
                  ng-options="t for t in ['full','partial']"
                  ng-change="vm.onOptionChange()">
                  <option value="">-- select --</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tuition Year</label>
                <select
                  class="block w-full rounded border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  ng-model="vm.edit.tuition_year"
                  ng-options="o.id as o.label for o in vm.tuitionYearOptions"
                  ng-change="vm.onOptionChange()">
                  <option value="">-- select --</option>
                </select>
              </div>
            </div>
  
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Allow Enroll</label>
                <select
                  class="block w-full rounded border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  ng-model="vm.edit.allow_enroll"
                  ng-options="v.value as v.label for v in [{value:0,label:'No'},{value:1,label:'Yes'}]"
                  ng-change="vm.onOptionChange()">
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Has Downpayment</label>
                <select
                  class="block w-full rounded border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  ng-model="vm.edit.downpayment"
                  ng-options="v.value as v.label for v in [{value:0,label:'No'},{value:1,label:'Yes'}]"
                  ng-change="vm.onOptionChange()">
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select
                  class="block w-full rounded border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  ng-model="vm.edit.enrollment_status"
                  ng-options="v.value as v.label for v in [
                    {value:'enlisted',label:'enlisted'},
                    {value:'enrolled',label:'enrolled'},
                    {value:'loa',label:'loa'},
                    {value:'withdrawn before',label:'withdrawn before'},
                    {value:'withdrawn after',label:'withdrawn after'},
                    {value:'withdrawn end',label:'withdrawn end'}                    
                  ]"
                  ng-change="vm.onOptionChange()">
                  <option value="">-- select --</option>
                </select>
              </div>
            </div>
  
            <div class="text-right">
              <button
                class="inline-flex items-center px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
                ng-disabled="vm.loading.update"
                ng-click="vm.updateRegistration()">
                <span ng-if="!vm.loading.update">Save</span>
                <span ng-if="vm.loading.update">Saving...</span>
              </button>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Tuition Card -->
      <div>
        <div class="border rounded-lg shadow-sm overflow-hidden">
          <div class="bg-sky-600 text-white px-4 py-2 flex items-center justify-between">
            <strong>Tuition Summary</strong>
            <div class="flex items-center gap-2">
              <span class="text-sm opacity-90" ng-if="vm.loading.tuition"><em>loading...</em></span>
              <button
                class="px-3 py-1 text-sm bg-white text-sky-700 rounded hover:bg-sky-50 disabled:opacity-50"
                ng-click="vm.openTuitionModal()"
                ng-disabled="!(vm.tuition || vm.tuitionSaved)">
                View Breakdown
              </button>
            </div>
          </div>
          <div class="p-4 bg-white">
            <div ng-if="!vm.tuition && !vm.tuitionSaved">
              <em class="text-gray-500">No tuition breakdown available.</em>
            </div>
            <div ng-if="vm.tuition || vm.tuitionSaved" class="space-y-3">
              <!-- Registered tuition amount, based on payment type -->
              <div>
                <div class="text-sm text-gray-500">Tuition Amount (Registered)</div>
                <div class="text-lg font-semibold">
                  P{{ vm.currency(
                    (vm.selectedTuitionAmount != null
                      ? vm.selectedTuitionAmount
                      : ((vm.registration && vm.registration.paymentType === 'partial')
                          ? (vm.tuition.total_installment || 0)
                          : (vm.tuition.total || 0)))
                    ) }}
                </div>
              </div>
  
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="space-y-1">
                  <div>Computed Total (Full): <strong>P{{ vm.currency(((vm.tuition && vm.tuition.total) || (vm.tuitionSaved && vm.tuitionSaved.payload && vm.tuitionSaved.payload.total) || 0)) }}</strong></div>
                  <div>Computed Total (Installment): <strong>P{{ vm.currency(((vm.tuition && vm.tuition.total_installment) || (vm.tuitionSaved && vm.tuitionSaved.payload && vm.tuitionSaved.payload.total_installment) || 0)) }}</strong></div>
                </div>
                <div class="space-y-1">
                  <div>Billing Total: <strong>P{{ vm.currency(vm.meta.billing_total || 0) }}</strong></div>
                  <div>Amount Paid: <strong class="text-green-600">P{{ vm.currency(vm.paymentDetailsTotal || 0) }}</strong></div>
                  <div>Remaining: <strong class="text-red-600">P{{ vm.currency(vm.meta.remaining_amount || 0) }}</strong></div>
                </div>
              </div>
  
              <div class="text-gray-500">
                <small>
                  Payment Type: {{ vm.edit.paymentType || (vm.registration && vm.registration.paymentType) || 'N/A' }}
                  <span class="ml-2">Source: {{ vm.meta.tuition_source === 'saved' ? 'Saved' : 'Computed' }}</span>
                </small>
              </div>

              <!-- Generate Tuition Invoice (visible only when no tuition invoice exists for this registration) -->
              <div class="mt-2" ng-if="vm.canShowGenerateInvoice()">
                <div class="rounded border border-amber-200 bg-amber-50 text-amber-800 px-3 py-2 mb-2">
                  No tuition invoice found for this registration.
                </div>
                <!-- Error alert when invoice generation fails -->
                <div class="rounded border border-red-200 bg-red-50 text-red-700 px-3 py-2 mb-2" ng-if="vm.invoiceGenerateError">
                  {{ vm.invoiceGenerateError }}
                </div>
                <button
                  class="inline-flex items-center px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50"
                  ng-click="vm.generateTuitionInvoice()"
                  ng-disabled="vm.generatingInvoice">
                  <span ng-if="!vm.generatingInvoice">Generate Invoice</span>
                  <span ng-if="vm.generatingInvoice">Generating...</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Tuition Breakdown Modal -->
    <div ng-if="vm.ui && vm.ui.showTuitionModal" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black bg-opacity-50" ng-click="vm.closeTuitionModal()"></div>
      <!-- Dialog -->
      <div class="relative bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 max-h-[80vh] overflow-auto"
           ng-click="$event.stopPropagation()"
           tabindex="0"
           ng-keydown="$event.keyCode===27 && vm.closeTuitionModal()">
        <div class="px-4 py-2 border-b flex items-center justify-between">
          <h3 class="text-lg font-semibold">Tuition Breakdown</h3>
          <button class="text-gray-600 hover:text-gray-800" ng-click="vm.closeTuitionModal()">
            <i class="fas fa-times"></i>
            <span class="sr-only">Close</span>
          </button>
        </div>
  
        <div class="p-4 space-y-4" ng-init="p = vm.tuitionPayload()">
          <div class="text-sm text-gray-600">
            <span>Source: <strong>{{ vm.meta.tuition_source === 'saved' ? 'Saved' : 'Computed' }}</strong></span>
          </div>
  
          <!-- DP Previews -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3" ng-if="p && p.summary" ng-init="prev = vm.installmentPreview(p)">
            <div class="bg-white border rounded p-3" ng-if="prev && prev.dp30">
              <div class="text-gray-500 uppercase text-xs">30% DP Preview</div>
              <div class="mt-1 text-sm space-y-1">
                <div>Tuition: â‚± {{ (prev.dp30.tuitionNew || 0) | number:2 }}</div>
                <div>Misc: â‚± {{ (prev.dp30.miscNew || 0) | number:2 }}</div>
                <div>Lab: â‚± {{ (prev.dp30.labNew || 0) | number:2 }}</div>
                <div>Additional: â‚± {{ (prev.dp30.additionalNew || 0) | number:2 }}</div>
                <div>Scholarships: -â‚± {{ (prev.dp30.scholarships || 0) | number:2 }}</div>
                <div>Discounts: -â‚± {{ (prev.dp30.discounts || 0) | number:2 }}</div>
                <div class="font-semibold text-indigo-700">Total: â‚± {{ (prev.dp30.totalNew || 0) | number:2 }}</div>
              </div>
              <div class="text-xs text-gray-500 mt-2">Note: Tuition +15%, Misc +15%. Lab and Additional unchanged.</div>
            </div>
            <div class="bg-white border rounded p-3" ng-if="prev && prev.dp50">
              <div class="text-gray-500 uppercase text-xs">50% DP Preview</div>
              <div class="mt-1 text-sm space-y-1">
                <div>Tuition: â‚± {{ (prev.dp50.tuitionNew || 0) | number:2 }}</div>
                <div>Misc: â‚± {{ (prev.dp50.miscNew || 0) | number:2 }}</div>
                <div>Lab: â‚± {{ (prev.dp50.labNew || 0) | number:2 }}</div>
                <div>Additional: â‚± {{ (prev.dp50.additionalNew || 0) | number:2 }}</div>
                <div>Scholarships: -â‚± {{ (prev.dp50.scholarships || 0) | number:2 }}</div>
                <div>Discounts: -â‚± {{ (prev.dp50.discounts || 0) | number:2 }}</div>
                <div class="font-semibold text-indigo-700">Total: â‚± {{ (prev.dp50.totalNew || 0) | number:2 }}</div>
              </div>
              <div class="text-xs text-gray-500 mt-2">Note: Tuition +9%, Misc +9%. Lab and Additional unchanged.</div>
            </div>
          </div>
  
          <!-- Summary -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm" ng-if="p && p.summary">
            <div class="bg-gray-50 border rounded p-3">
              <div class="text-gray-500 uppercase text-xs">Tuition</div>
              <div class="font-semibold">â‚± {{ (p.summary.tuition || 0) | number:2 }}</div>
            </div>
            <div class="bg-gray-50 border rounded p-3">
              <div class="text-gray-500 uppercase text-xs">Misc</div>
              <div class="font-semibold">â‚± {{ (p.summary.misc_total || 0) | number:2 }}</div>
            </div>
            <div class="bg-gray-50 border rounded p-3">
              <div class="text-gray-500 uppercase text-xs">Lab</div>
              <div class="font-semibold">â‚± {{ (p.summary.lab_total || 0) | number:2 }}</div>
            </div>
            <div class="bg-gray-50 border rounded p-3">
              <div class="text-gray-500 uppercase text-xs">Additional</div>
              <div class="font-semibold">â‚± {{ (p.summary.additional_total || 0) | number:2 }}</div>
            </div>
            <div class="bg-gray-50 border rounded p-3">
              <div class="text-gray-500 uppercase text-xs">Scholarships</div>
              <div class="font-semibold text-green-700">â‚± {{ (p.summary.scholarships_total || 0) | number:2 }}</div>
            </div>
            <div class="bg-gray-50 border rounded p-3">
              <div class="text-gray-500 uppercase text-xs">Discounts</div>
              <div class="font-semibold text-green-700">â‚± {{ (p.summary.discounts_total || 0) | number:2 }}</div>
            </div>
            <div class="bg-gray-50 border rounded p-3">
              <div class="text-gray-500 uppercase text-xs">Billing</div>
              <div class="font-semibold">â‚± {{ (p.summary.billing_total || 0) | number:2 }}</div>
            </div>
            <div class="bg-gray-100 border rounded p-3 md:col-span-2">
              <div class="text-gray-500 uppercase text-xs">Total Due</div>
              <div class="font-semibold text-indigo-700 text-lg">
                â‚± {{ (p.summary.total_due || p.total || p.summary.total || 0) | number:2 }}
              </div>
            </div>
          </div>
  
          <div ng-if="!p" class="text-gray-500">
            <em>No tuition data available.</em>
          </div>
  
          <!-- Tuition Items -->
          <div ng-if="p && p.items && p.items.tuition && p.items.tuition.length">
            <h4 class="font-semibold">Tuition Items</h4>
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2 pr-4">Code</th>
                  <th class="py-2 pr-4">Units</th>
                  <th class="py-2 pr-4">Rate</th>
                  <th class="py-2 pr-4">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="t in p.items.tuition" class="border-b">
                  <td class="py-2 pr-4 font-mono">{{t.code || 'â€”'}}</td>
                  <td class="py-2 pr-4">{{t.units || 0}}</td>
                  <td class="py-2 pr-4">â‚± {{ (t.rate || 0) | number:2 }}</td>
                  <td class="py-2 pr-4">â‚± {{ (t.amount || 0) | number:2 }}</td>
                </tr>
              </tbody>
            </table>
          </div>
  
          <!-- Misc Items -->
          <div ng-if="p && p.items && p.items.misc && p.items.misc.length">
            <h4 class="font-semibold">Misc Fees</h4>
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2 pr-4">Name</th>
                  <th class="py-2 pr-4">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="m in p.items.misc" class="border-b">
                  <td class="py-2 pr-4">{{m.name || 'â€”'}}</td>
                  <td class="py-2 pr-4">â‚± {{ (m.amount || 0) | number:2 }}</td>
                </tr>
              </tbody>
            </table>
          </div>
  
          <!-- Lab Items -->
          <div ng-if="p && p.items && p.items.lab && p.items.lab.length">
            <h4 class="font-semibold">Lab Fees</h4>
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2 pr-4">Subject Code</th>
                  <th class="py-2 pr-4">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="l in p.items.lab" class="border-b">
                  <td class="py-2 pr-4 font-mono">{{l.code || 'â€”'}}</td>
                  <td class="py-2 pr-4">â‚± {{ (l.amount || 0) | number:2 }}</td>
                </tr>
              </tbody>
            </table>
          </div>
  
          <!-- Scholarships and Discounts -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div ng-if="p && p.items && p.items.scholarships && p.items.scholarships.length">
              <h4 class="font-semibold">Scholarships</h4>
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left border-b">
                    <th class="py-2 pr-4">Name</th>
                    <th class="py-2 pr-4">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="s in p.items.scholarships" class="border-b">
                    <td class="py-2 pr-4">{{s.name || 'â€”'}}</td>
                    <td class="py-2 pr-4 text-green-700">â‚± {{ (s.amount || 0) | number:2 }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div ng-if="p && p.items && p.items.discounts && p.items.discounts.length">
              <h4 class="font-semibold">Discounts</h4>
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left border-b">
                    <th class="py-2 pr-4">Name</th>
                    <th class="py-2 pr-4">Percent</th>
                    <th class="py-2 pr-4">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="d in p.items.discounts" class="border-b">
                    <td class="py-2 pr-4">{{d.name || 'â€”'}}</td>
                    <td class="py-2 pr-4">{{d.percent != null ? (d.percent + '%') : 'â€”'}}</td>
                    <td class="py-2 pr-4 text-green-700">â‚± {{ (d.amount || 0) | number:2 }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
  
          <!-- Additional Items -->
          <div ng-if="p && p.items && p.items.additional && p.items.additional.length">
            <h4 class="font-semibold">Additional Charges</h4>
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2 pr-4">Name</th>
                  <th class="py-2 pr-4">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="a in p.items.additional" class="border-b">
                  <td class="py-2 pr-4">{{a.name || 'â€”'}}</td>
                  <td class="py-2 pr-4">â‚± {{ (a.amount || 0) | number:2 }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Billing Items -->
          <div ng-if="p && p.items && p.items.billing && p.items.billing.length">
            <h4 class="font-semibold">Billing Items</h4>
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2 pr-4">Description</th>
                  <th class="py-2 pr-4">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="b in p.items.billing" class="border-b">
                  <td class="py-2 pr-4">{{ b.name || 'â€”' }}</td>
                  <td class="py-2 pr-4" ng-class="{'text-red-700': (b.amount || 0) < 0, 'text-gray-900': (b.amount || 0) >= 0}">
                    â‚± {{ (b.amount || 0) | number:2 }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Invoice Details Modal -->
    <div ng-if="vm.ui && vm.ui.showInvoiceModal" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black bg-opacity-50" ng-click="vm.closeInvoiceModal()"></div>
      <!-- Dialog -->
      <div class="relative bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 max-h-[80vh] overflow-auto"
           ng-click="$event.stopPropagation()"
           tabindex="0"
           ng-keydown="$event.keyCode===27 && vm.closeInvoiceModal()">
        <div class="px-4 py-2 border-b flex items-center justify-between">
          <h3 class="text-lg font-semibold">
            Invoice Details â€” {{ (vm.invoiceModal.invoice && (vm.invoiceModal.invoice.invoice_number || vm.invoiceModal.invoice.number)) || 'N/A' }}
          </h3>
          <div class="flex items-center gap-2">
            <button
              class="inline-flex items-center px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50"
              ng-click="vm.printInvoice(vm.invoiceModal.invoice)"
              ng-disabled="!vm.invoiceModal.invoice || vm.isPrinting(vm.invoiceModal.invoice)">
              <span ng-if="!vm.isPrinting(vm.invoiceModal.invoice)">Print PDF</span>
              <span ng-if="vm.isPrinting(vm.invoiceModal.invoice)">Printing...</span>
            </button>
            <button class="text-gray-600 hover:text-gray-800" ng-click="vm.closeInvoiceModal()">
              <i class="fas fa-times"></i>
              <span class="sr-only">Close</span>
            </button>
          </div>
        </div>
        <div class="p-4 space-y-4">
          <!-- Header info -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3" ng-if="vm.invoiceModal.invoice">
            <div class="text-sm text-gray-700">
              <div><span class="text-gray-500">Type:</span> <strong>{{ vm.invoiceModal.invoice.type || '-' }}</strong></div>
              <div><span class="text-gray-500">Status:</span> <strong>{{ vm.invoiceModal.invoice.status || '-' }}</strong></div>
              <div><span class="text-gray-500">Date:</span> <strong>{{ vm.invoiceModal.invoice.posted_at || vm.invoiceModal.invoice.created_at || '' }}</strong></div>
            </div>
            <div class="text-sm text-gray-700">
              <div><span class="text-gray-500">Remarks:</span> <span>{{ vm.invoiceModal.invoice.remarks || '' }}</span></div>
            </div>
          </div>
          <!-- Totals -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="rounded border border-gray-200 bg-gray-50 px-4 py-3">
              <div class="text-xs text-gray-500 uppercase">Total</div>
              <div class="text-lg font-semibold text-gray-900">P{{ vm.currency(vm.invoiceModal.totals.total || 0) }}</div>
            </div>
            <div class="rounded border border-emerald-200 bg-emerald-50 px-4 py-3">
              <div class="text-xs text-emerald-700 uppercase">Paid</div>
              <div class="text-lg font-semibold text-emerald-900">P{{ vm.currency(vm.invoiceModal.totals.paid || 0) }}</div>
            </div>
            <div class="rounded border border-red-200 bg-red-50 px-4 py-3">
              <div class="text-xs text-red-700 uppercase">Remaining</div>
              <div class="text-lg font-semibold text-red-900">P{{ vm.currency(vm.invoiceModal.totals.remaining || 0) }}</div>
            </div>
          </div>
          <!-- Invoice Items -->
          <div ng-if="vm.invoiceModal.items && vm.invoiceModal.items.length">
            <h4 class="font-semibold">Invoice Items</h4>
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2 pr-4">Item</th>
                  <th class="py-2 pr-4 text-right">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr class="border-b" ng-repeat="it in vm.invoiceModal.items">
                  <td class="py-2 pr-4">{{ it.description || it.name || it.code || 'â€”' }}</td>
                  <td class="py-2 pr-4 text-right">â‚± {{ (it.amount || it.total || 0) | number:2 }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Payments linked to this invoice -->
          <div>
            <h4 class="font-semibold">Payments</h4>
            <div class="max-h-72 overflow-auto border rounded">
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-3 py-2 text-left">Date</th>
                    <th class="px-3 py-2 text-left">OR#</th>
                    <th class="px-3 py-2 text-left">Description</th>
                    <th class="px-3 py-2 text-right">Subtotal</th>
                    <th class="px-3 py-2 text-left">Status</th>
                    <th class="px-3 py-2 text-left">Method</th>
                    <th class="px-3 py-2 text-left">School Year</th>
                  </tr>
                </thead>
                <tbody ng-if="vm.invoiceModal.payments && vm.invoiceModal.payments.length">
                  <tr class="odd:bg-white even:bg-gray-50" ng-repeat="p in vm.invoiceModal.payments">
                    <td class="px-3 py-2">{{ p.or_date || p.posted_at || '' }}</td>
                    <td class="px-3 py-2">{{ p.or_no }}</td>
                    <td class="px-3 py-2">{{ p.description }}</td>
                    <td class="px-3 py-2 text-right">P{{ vm.currency(p.subtotal_order) }}</td>
                    <td class="px-3 py-2">{{ p.status }}</td>
                    <td class="px-3 py-2">{{ p.method }}</td>
                    <td class="px-3 py-2">{{ (vm.paymentDetails && vm.paymentDetails.sy_label) || p.sy_reference }}</td>
                  </tr>
                </tbody>
              </table>
              <div class="p-3 text-gray-500" ng-if="!vm.invoiceModal.payments || !vm.invoiceModal.payments.length">
                <em>No payments linked to this invoice.</em>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Assign Number Modal (Tailwind) -->
    <div ng-if="vm.ui && vm.ui.showAssignNumberModal" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black bg-opacity-50" ng-click="vm.closeAssignNumberModal()"></div>
      <!-- Dialog -->
      <div class="relative bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[80vh] overflow-auto"
           ng-click="$event.stopPropagation()"
           tabindex="0"
           ng-keydown="$event.keyCode===27 && vm.closeAssignNumberModal()">
        <div class="px-4 py-2 border-b flex items-center justify-between">
          <h3 class="text-lg font-semibold">Assign Number to Payment</h3>
          <button class="text-gray-600 hover:text-gray-800" ng-click="vm.closeAssignNumberModal()">
            <i class="fas fa-times"></i>
            <span class="sr-only">Close</span>
          </button>
        </div>

        <div class="p-4 space-y-4">
          <!-- Payment Info -->
          <div class="mb-3 p-3 bg-gray-50 rounded" ng-if="vm.assignNumberPayment">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <small class="text-gray-500">Date:</small><br>
                <strong>{{ vm.assignNumberPayment.or_date || vm.assignNumberPayment.posted_at || '' }}</strong>
              </div>
              <div class="text-right sm:text-left">
                <small class="text-gray-500">Amount:</small><br>
                <strong>P{{ vm.currency(vm.assignNumberPayment.subtotal_order) }}</strong>
              </div>
              <div class="sm:col-span-2">
                <small class="text-gray-500">Description:</small><br>
                <strong>{{ vm.assignNumberPayment.description }}</strong>
              </div>
            </div>
          </div>

          <!-- Error Alert -->
          <div class="rounded border border-red-200 bg-red-50 text-red-700 px-4 py-3" ng-if="vm.assignNumberError">
            {{ vm.assignNumberError }}
          </div>

          <!-- Type Selection -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Number Type</label>
            <div class="flex items-center gap-4">
              <label class="inline-flex items-center">
                <input class="mr-2" type="radio" name="assignNumberType"
                       ng-model="vm.assignNumber.type" value="or"
                       ng-disabled="vm.assignNumberPayment && vm.assignNumberPayment.or_no">
                OR
                <span class="text-xs text-gray-500 ml-2" ng-if="vm.assignNumberPayment && vm.assignNumberPayment.or_no">(already assigned)</span>
              </label>
              <label class="inline-flex items-center">
                <input class="mr-2" type="radio" name="assignNumberType"
                       ng-model="vm.assignNumber.type" value="invoice"
                       ng-disabled="vm.assignNumberPayment && vm.assignNumberPayment.invoice_number">
                Invoice
                <span class="text-xs text-gray-500 ml-2" ng-if="vm.assignNumberPayment && vm.assignNumberPayment.invoice_number">(already assigned)</span>
              </label>
            </div>
          </div>

          <!-- Invoice selection when assigning Invoice number -->
          <div ng-if="vm.assignNumber.type === 'invoice' && vm.invoices && vm.invoices.length">
            <label class="block text-sm font-medium text-gray-700 mb-1">Select Invoice</label>
            <select
              class="block w-full rounded border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              ng-model="vm.assignNumber.selectedInvoiceId"
              ng-options="inv.id as ((inv.invoice_number || inv.number) + ' â€” P' + vm.currency(inv.amount_total || inv.amount || inv.total || 0) + (inv._remaining != null ? (' â€” Rem P' + vm.currency(inv._remaining)) : '')) for inv in vm.invoices track by inv.id"
              ng-change="vm.onAssignInvoiceSelected()">
              <option value="">-- select invoice --</option>
            </select>
            <div class="text-xs text-gray-600 mt-1" ng-if="vm.assignNumber.selectedInvoiceId && vm.assignNumber.selectedInvoiceNumber">
              Selected #: {{ vm.assignNumber.selectedInvoiceNumber }}
            </div>
          </div>

          <!-- Next Available Number -->
          <div class="rounded border border-blue-200 bg-blue-50 text-blue-700 px-3 py-2" ng-if="vm.assignNumber.type">
            <div ng-if="vm.assignNumber.type === 'or'">
              <strong>Next Available OR Number:</strong>
              {{ (vm.myCashier && vm.myCashier.or && vm.myCashier.or.current) || 'N/A' }}
              <span class="ml-2 text-xs opacity-80" ng-if="vm.myCashier && vm.myCashier.or && (vm.myCashier.or.start || vm.myCashier.or.end)">
                (Range: {{ vm.myCashier.or.start || 'â€”' }}â€“{{ vm.myCashier.or.end || 'â€”' }})
              </span>
            </div>
            <div ng-if="vm.assignNumber.type === 'invoice'">
              <strong>Next Available Invoice Number:</strong>
              {{ (vm.myCashier && vm.myCashier.invoice && vm.myCashier.invoice.current) || 'N/A' }}
              <span class="ml-2 text-xs opacity-80" ng-if="vm.myCashier && vm.myCashier.invoice && (vm.myCashier.invoice.start || vm.myCashier.invoice.end)">
                (Range: {{ vm.myCashier.invoice.start || 'â€”' }}â€“{{ vm.myCashier.invoice.end || 'â€”' }})
              </span>
            </div>
          </div>

          <!-- Custom Number -->
          <div ng-if="vm.assignNumber.type">
            <label class="block text-sm font-medium text-gray-700 mb-1">Custom Number (Optional)</label>
            <input type="number" class="block w-full rounded border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                   ng-model="vm.assignNumber.customNumber"
                   placeholder="Leave blank to use next available number" />
          </div>

          <!-- Warning -->
          <div class="rounded border border-amber-200 bg-amber-50 text-amber-800 px-3 py-2"
               ng-if="vm.assignNumber.type && !vm.hasAvailableNumbers()">
            No numbers available from your assigned range. Enter a custom number or check your assigned sequence.
          </div>

          <!-- Footer -->
          <div class="pt-2 border-t flex items-center justify-end gap-2">
            <button class="inline-flex items-center px-3 py-2 rounded border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
                    ng-click="vm.closeAssignNumberModal()">
              Cancel
            </button>
            <button class="inline-flex items-center px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50"
                    ng-click="vm.confirmAssignNumber()"
                    ng-disabled="!vm.canAssignNumber() || vm.loading.assignNumber">
              <span ng-if="!vm.loading.assignNumber">Assign</span>
              <span ng-if="vm.loading.assignNumber"><i class="fas fa-spinner fa-spin"></i>&nbsp;Assigning...</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Application Fee (Applicants) -->
    <div class="mt-6" ng-if="vm.canShowGenerateApplicationFee()">
      <div class="rounded border border-amber-200 bg-amber-50 text-amber-800 px-4 py-3 mb-2">
        Application fee billing and invoice not found for this term.
      </div>
      <div class="rounded border border-red-200 bg-red-50 text-red-700 px-4 py-3 mb-2" ng-if="vm.appFeeGenerateError">
        {{ vm.appFeeGenerateError }}
      </div>
      <button
        class="inline-flex items-center px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50"
        ng-click="vm.generateApplicationPayment()"
        ng-disabled="vm.generatingAppFee">
        <span ng-if="!vm.generatingAppFee">Generate Application Fee</span>
        <span ng-if="vm.generatingAppFee">Generating...</span>
      </button>
    </div>

    <!-- Reservation Fee (Applicants) -->
    <div class="mt-4" ng-if="vm.canShowGenerateReservationFee()">
      <div class="rounded border border-amber-200 bg-amber-50 text-amber-800 px-4 py-3 mb-2">
        Reservation fee billing and invoice not found for this term.
      </div>
      <div class="rounded border border-red-200 bg-red-50 text-red-700 px-4 py-3 mb-2" ng-if="vm.resFeeGenerateError">
        {{ vm.resFeeGenerateError }}
      </div>
      <button
        class="inline-flex items-center px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50"
        ng-click="vm.generateReservationPayment()"
        ng-disabled="vm.generatingResFee">
        <span ng-if="!vm.generatingResFee">Generate Reservation Fee</span>
        <span ng-if="vm.generatingResFee">Generating...</span>
      </button>
    </div>

    <!-- Invoices -->
    <div class="mt-6">
      <div class="border rounded-lg shadow-sm overflow-hidden">
        <div class="bg-indigo-600 text-white px-4 py-2 flex items-center justify-between">
          <strong>Invoices</strong>
          <span class="text-sm opacity-90" ng-if="vm.loading.invoices"><em>loading...</em></span>
        </div>
        <div class="p-4 bg-white">
          <div class="text-sm text-gray-600 mb-3">
            <span ng-if="vm.termLabel">Term: <strong>{{ vm.termLabel }}</strong></span>
            <span ng-if="!vm.termLabel" class="text-gray-500">Term not resolved.</span>
          </div>

          <!-- Error message -->
          <div class="rounded border border-red-200 bg-red-50 text-red-700 px-4 py-3 mb-3" ng-if="vm.error.invoices">
            {{ vm.error.invoices }}
          </div>

          <!-- Table -->
          <div class="max-h-96 overflow-auto">
            <table class="w-full text-sm border border-gray-200 rounded">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left">Date</th>
                  <th class="px-3 py-2 text-left">Invoice</th>
                  <th class="px-3 py-2 text-left">Type</th>
                  <th class="px-3 py-2 text-left">Status</th>
                  <th class="px-3 py-2 text-right">Amount</th>
                  <th class="px-3 py-2 text-right">Paid</th>
                  <th class="px-3 py-2 text-right">Remaining</th>
                  <th class="px-3 py-2 text-left">Remarks</th>
                  <th class="px-3 py-2 text-left">Action</th>
                </tr>
              </thead>
              <tbody ng-if="vm.invoices && vm.invoices.length">
                <tr class="odd:bg-white even:bg-gray-50" ng-repeat="inv in vm.invoices">
                  <td class="px-3 py-2">{{ inv.posted_at || inv.created_at || '' }}</td>
                  <td class="px-3 py-2">{{ inv.invoice_number || inv.number }}</td>
                  <td class="px-3 py-2">{{ inv.type || '-' }}</td>
                  <td class="px-3 py-2">{{ inv.status || '-' }}</td>
                  <td class="px-3 py-2 text-right">P{{ vm.currency(inv.amount_total || inv.amount || inv.total || 0) }}</td>
                  <td class="px-3 py-2 text-right">P{{ vm.currency(inv._paid || 0) }}</td>
                  <td class="px-3 py-2 text-right" ng-class="{'text-red-700': (inv._remaining || 0) > 0, 'text-gray-500': (inv._remaining || 0) === 0}">P{{ vm.currency(inv._remaining || 0) }}</td>
                  <td class="px-3 py-2">{{ inv.remarks || '' }}</td>
                  <td class="px-3 py-2">
                    <button
                      class="inline-flex items-center px-2 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700"
                      ng-click="vm.openInvoiceModal(inv)">
                      View
                    </button>
                    <button
                      class="inline-flex items-center px-2 py-1 rounded border border-indigo-600 text-indigo-700 hover:bg-indigo-50 ml-2 disabled:opacity-50"
                      ng-click="vm.printInvoice(inv)"
                      ng-disabled="vm.isPrinting(inv)">
                      <span ng-if="!vm.isPrinting(inv)">Print</span>
                      <span ng-if="vm.isPrinting(inv)">Printing...</span>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="mt-2 text-gray-500" ng-if="!vm.invoices || !vm.invoices.length">
              <em>No invoices found for the selected term.</em>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payments (from payment_details) -->
    <div class="mt-6">
      <div class="border rounded-lg shadow-sm overflow-hidden">
        <div class="bg-emerald-600 text-white px-4 py-2 flex items-center justify-between">
          <strong>Payments</strong>
          <span class="text-sm opacity-90" ng-if="vm.loading.payments"><em>loading...</em></span>
        </div>
        <div class="p-4 bg-white">
          <div class="text-sm text-gray-600 mb-3">
            <span ng-if="vm.paymentDetails && vm.paymentDetails.sy_label">
              Term: <strong>{{ vm.paymentDetails.sy_label }}</strong>
            </span>
            <span ng-if="!vm.paymentDetails || !vm.paymentDetails.sy_label" class="text-gray-500">
              Term not resolved.
            </span>
          </div>

          <!-- Cashier Current Numbers (OR and Invoice) -->
          <div class="mb-3" ng-if="vm.myCashier">
            <div class="rounded border border-amber-200 bg-amber-50 text-amber-800 px-3 py-2">
              <span>
                Current OR#:
                <strong>{{ (vm.myCashier.or &amp;&amp; vm.myCashier.or.current) || 'N/A' }}</strong>
                <span class="ml-2 text-xs text-amber-900" ng-if="vm.myCashier.or &amp;&amp; (vm.myCashier.or.start || vm.myCashier.or.end)">
                  (Range: {{ vm.myCashier.or.start || 'â€”' }}â€“{{ vm.myCashier.or.end || 'â€”' }})
                </span>
              </span>
              <span class="ml-4">
                Current Invoice#:
                <strong>{{ (vm.myCashier.invoice &amp;&amp; vm.myCashier.invoice.current) || 'N/A' }}</strong>
                <span class="ml-2 text-xs text-amber-900" ng-if="vm.myCashier.invoice &amp;&amp; (vm.myCashier.invoice.start || vm.myCashier.invoice.end)">
                  (Range: {{ vm.myCashier.invoice.start || 'â€”' }}â€“{{ vm.myCashier.invoice.end || 'â€”' }})
                </span>
              </span>
            </div>
          </div>

          <!-- Add Payment (visible to Finance/Admin only) -->
          <div class="mb-4" ng-if="vm.canEdit">
            <div class="rounded border border-emerald-200 bg-emerald-50">
              <div class="px-4 py-2 flex items-center justify-between">
                <strong class="text-emerald-800">Add Payment</strong>
                <span class="text-xs text-emerald-700" ng-if="vm.loading.createPayment"><em>submitting...</em></span>
              </div>
              <div class="p-4 bg-white border-t">
                <!-- Missing cashier notice -->
                <div class="rounded border border-yellow-200 bg-yellow-50 text-yellow-700 px-4 py-3 mb-3" ng-if="!vm.myCashier">
                  No assigned cashier found for your faculty account. You can view payments, but cannot add a payment until a cashier assignment exists.
                </div>

                <!-- Error message -->
                <div class="rounded border border-red-200 bg-red-50 text-red-700 px-4 py-3 mb-3" ng-if="vm.paymentError">
                  {{ vm.paymentError }}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4" ng-if="vm.myCashier">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Numbering Mode</label>
                    <select
                      class="block w-full rounded border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      ng-model="vm.payment.mode"
                      ng-change="vm.onModeChange()">
                      <option value="or">Official Receipt (OR)</option>
                      <option value="invoice">Invoice</option>
                      <option value="none">None (No Number)</option>
                    </select>
                    <div class="text-xs text-gray-600 mt-1">
                      <span ng-if="vm.payment.mode === 'or'">Uses OR numbering sequence</span>
                      <span ng-if="vm.payment.mode === 'invoice'">Uses Invoice numbering sequence</span>
                      <span ng-if="vm.payment.mode === 'none'">Payment without OR/Invoice number</span>
                    </div>
                  </div>
                  <div ng-if="vm.payment.mode === 'or' && vm.invoices && vm.invoices.length">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice (optional)</label>
                    <select
                      class="block w-full rounded border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      ng-model="vm.payment.invoice_id"
                      ng-options="inv.id as ((inv.invoice_number || inv.number) + ' â€” P' + vm.currency(inv.amount_total || inv.amount || inv.total || 0)) for inv in vm.invoices track by inv.id"
                      ng-change="vm.onInvoiceSelected()">
                      <option value="">-- select invoice --</option>
                    </select>
                    <div class="text-xs text-gray-600 mt-1" ng-if="vm.payment.invoice_id && vm.invoiceCtx && vm.invoiceCtx.number">
                      <span>Invoice Total: P{{ vm.currency(vm.invoiceCtx.total || 0) }}</span>
                      <span class="ml-2">Paid: <span class="text-green-700">P{{ vm.currency(vm.invoiceCtx.paid || 0) }}</span></span>
                      <span class="ml-2">Remaining: <span ng-class="{'text-red-700': (vm.invoiceCtx.remaining || 0) > 0, 'text-gray-500': (vm.invoiceCtx.remaining || 0) === 0}">P{{ vm.currency(vm.invoiceCtx.remaining || 0) }}</span></span>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                    <input type="number" step="0.01" min="0.01" inputmode="decimal"
                      class="block w-full rounded border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      ng-model="vm.payment.amount"
                      ng-attr-max="{{ vm.amountMax() || undefined }}"
                      ng-change="vm.onAmountChange()"
                      ng-blur="vm.onAmountBlur()"
                      ng-pattern="/^\d+(\.\d{1,2})?$/"
                      placeholder="0.00" />
                    <div class="text-xs mt-1" ng-if="vm.payment.invoice_id && (vm.amountMax() != null)">
                      <span class="text-gray-600">Max: P{{ vm.currency(vm.amountMax() || 0) }}</span>
                      <span class="ml-2 text-red-600" ng-if="vm.payment.amount && (parseFloat(vm.payment.amount) > (vm.amountMax() + 0.00001))">Amount exceeds remaining.</span>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Mode</label>
                    <input
                      type="text"
                      class="block w-full rounded border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      placeholder="Select a payment mode"
                      pui-autocomplete
                      ng-model="vm.payment.mode_of_payment_id"
                      pui-source="vm.paymentModes"
                      pui-item-key="id"
                      pui-label="(item.name + (item.pchannel ? ' â€” ' + item.pchannel : '') + (item.pmethod ? ' â€” ' + item.pmethod : ''))"
                      pui-on-select="vm.onPaymentModeChange()"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Method (optional)</label>
                    <input type="text"
                      class="block w-full rounded border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      ng-model="vm.payment.method" placeholder="e.g., Cash, GCash, Bank" />
                  </div>                  
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4" ng-if="vm.myCashier">
                  <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <select
                      ng-model="vm.payment.description"
                      ng-options="d for d in vm.paymentDescriptionOptions track by d"
                      ng-change="vm.onPaymentDescriptionChange()"                                                             
                      class="block w-full rounded border border-gray-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    >                                                                          
                    </select>
                  </div>
                </div>

                <div class="mt-4" ng-if="vm.myCashier">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Remarks</label>
                  <textarea rows="2"
                    class="block w-full rounded border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    ng-model="vm.payment.remarks" placeholder="Required"></textarea>
                </div>

                <div class="mt-4 text-right" ng-if="vm.myCashier">
                  <button
                    class="inline-flex items-center px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50"
                    ng-disabled="!vm.canSubmitPayment()"
                    ng-click="vm.submitPayment()">
                    <span ng-if="!vm.loading.createPayment">Submit Payment</span>
                    <span ng-if="vm.loading.createPayment">Submitting...</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
  
          <!-- Totals comparison -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div class="rounded border border-emerald-200 bg-emerald-50 px-4 py-3">
              <div class="text-sm text-emerald-700">Payment Details Total (Paid Tuition/Reservation)</div>
              <div class="text-xl font-semibold text-emerald-900">
                P{{ vm.currency(vm.paymentDetailsTotal || 0) }}
              </div>
            </div>
            <div class="rounded border border-gray-200 bg-gray-50 px-4 py-3">
              <div class="text-sm text-gray-700">Transactions Total (for comparison)</div>
              <div class="text-xl font-semibold text-gray-900">
                P{{ vm.currency(vm.transactionsTotal || 0) }}
              </div>
            </div>
          </div>
  
          <!-- Table -->
          <div class="max-h-96 overflow-auto">
            <table class="w-full text-sm border border-gray-200 rounded">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left">Date</th>
                  <th class="px-3 py-2 text-left">OR#</th>
                  <th class="px-3 py-2 text-left">Invoice</th>
                  <th class="px-3 py-2 text-left">Description</th>
                  <th class="px-3 py-2 text-right">Subtotal</th>
                  <th class="px-3 py-2 text-left">Status</th>
                  <th class="px-3 py-2 text-left">Method</th>
                  <th class="px-3 py-2 text-left">School Year</th>
                  <th class="px-3 py-2 text-left" ng-if="vm.canEdit && vm.myCashier">Assign</th>
                </tr>
              </thead>
              <tbody ng-if="vm.paymentDetails && vm.paymentDetails.items && vm.paymentDetails.items.length">
                <tr class="odd:bg-white even:bg-gray-50" ng-repeat="p in vm.paymentDetails.items">
                  <td class="px-3 py-2">{{ p.or_date || p.posted_at || '' }}</td>
                  <td class="px-3 py-2">{{ p.or_no }}</td>
                  <td class="px-3 py-2">{{ p.invoice_number }}</td>
                  <td class="px-3 py-2">{{ p.description }}</td>
                  <td class="px-3 py-2 text-right">P{{ vm.currency(p.subtotal_order) }}</td>
                  <td class="px-3 py-2">{{ p.status }}</td>
                  <td class="px-3 py-2">{{ p.method }}</td>
                  <td class="px-3 py-2">{{ vm.paymentDetails.sy_label || p.sy_reference }}</td>
                  <td class="px-3 py-2" ng-if="vm.canEdit">
                    <button
                      class="inline-flex items-center px-2 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50"
                      ng-if="vm.canShowAssignButton(p)"
                      ng-click="vm.openAssignNumberModal(p)">
                      Assign Number
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
  
            <div class="mt-2 text-gray-500" ng-if="!vm.paymentDetails || !vm.paymentDetails.items || !vm.paymentDetails.items.length">
              <em>No payment details found.</em>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Ledger + Records -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
      <!-- Ledger Card -->
      <div>
        <div class="border rounded-lg shadow-sm overflow-hidden">
          <div class="bg-gray-100 text-gray-800 px-4 py-2 flex items-center justify-between">
            <strong>Ledger</strong>
            <span class="text-sm opacity-90" ng-if="vm.loading.ledger"><em>loading...</em></span>
          </div>
          <div class="p-4 bg-white">
            <div class="max-h-96 overflow-auto">
              <table class="w-full text-sm border border-gray-200 rounded">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-3 py-2 text-left">Date</th>
                    <th class="px-3 py-2 text-left">Description</th>
                    <th class="px-3 py-2 text-right">Amount</th>
                    <th class="px-3 py-2 text-left">OR#</th>
                  </tr>
                </thead>
                <tbody ng-if="(vm.ledger && vm.ledger.transactions && vm.ledger.transactions.length) || (vm.ledger && vm.ledger.ledger && vm.ledger.ledger.length)">
                  <tr class="odd:bg-white even:bg-gray-50" ng-repeat="t in (vm.ledger.transactions || vm.ledger.ledger)">
                    <td class="px-3 py-2">{{ t.posted_at || t.date }}</td>
                    <td class="px-3 py-2">{{ t.type || t.name }}</td>
                    <td class="px-3 py-2 text-right">P{{ vm.currency(t.amount) }}</td>
                    <td class="px-3 py-2">{{ t.or_no || t.or_number }}</td>
                  </tr>
                </tbody>
              </table>
  
              <div class="mt-2 text-gray-500" ng-if="!vm.ledger || ((!vm.ledger.transactions || !vm.ledger.transactions.length) && (!vm.ledger.ledger || !vm.ledger.ledger.length))">
                <em>No ledger entries found.</em>
              </div>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Records Card -->
      <div>
        <div class="border rounded-lg shadow-sm overflow-hidden">
          <div class="bg-gray-100 text-gray-800 px-4 py-2 flex items-center justify-between">
            <strong>Subjects (Selected Term)</strong>
            <span class="text-sm opacity-90" ng-if="vm.loading.records"><em>loading...</em></span>
          </div>
          <div class="p-4 bg-white">
            <div class="max-h-96 overflow-auto">
              <div class="text-gray-500" ng-if="!vm.records || (!vm.records.records && !vm.records.terms)">
                <em>No records found.</em>
              </div>
  
              <!-- By-term shape -->
              <div ng-if="vm.records && vm.records.terms && vm.records.terms.length">
                <div ng-repeat="term in vm.records.terms" class="mb-4">
                  <h5 class="font-medium text-gray-800 mb-2">{{ term.term || term.label || ('SY ' + (term.syid || '')) }}</h5>
                  <table class="w-full text-sm border border-gray-200 rounded">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-3 py-2 text-left">Code</th>
                        <th class="px-3 py-2 text-left">Description</th>
                        <th class="px-3 py-2 text-left">Units</th>
                        <th class="px-3 py-2 text-left">Remarks</th>
                        <th class="px-3 py-2 text-left">Final</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="odd:bg-white even:bg-gray-50" ng-repeat="r in term.records">
                        <td class="px-3 py-2">{{ r.code }}</td>
                        <td class="px-3 py-2">{{ r.description }}</td>
                        <td class="px-3 py-2">{{ r.units }}</td>
                        <td class="px-3 py-2">{{ r.remarks }}</td>
                        <td class="px-3 py-2">{{ r.grades && r.grades.final ? r.grades.final : '' }}</td>
                      </tr>
                    </tbody>
                  </table>
                  <div class="border-t my-4"></div>
                </div>
              </div>
  
              <!-- Flat shape -->
              <div ng-if="vm.records && vm.records.records && vm.records.records.length && !vm.records.terms">
                <table class="w-full text-sm border border-gray-200 rounded">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-3 py-2 text-left">Code</th>
                      <th class="px-3 py-2 text-left">Description</th>
                      <th class="px-3 py-2 text-left">Units</th>
                      <th class="px-3 py-2 text-left">Remarks</th>
                      <th class="px-3 py-2 text-left">Final</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="odd:bg-white even:bg-gray-50" ng-repeat="r in vm.records.records">
                      <td class="px-3 py-2">{{ r.code }}</td>
                      <td class="px-3 py-2">{{ r.description }}</td>
                      <td class="px-3 py-2">{{ r.units }}</td>
                      <td class="px-3 py-2">{{ r.remarks }}</td>
                      <td class="px-3 py-2">{{ r.grades && r.grades.final ? r.grades.final : '' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
  
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  