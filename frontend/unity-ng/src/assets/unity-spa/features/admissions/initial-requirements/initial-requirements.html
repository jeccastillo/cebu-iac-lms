<div class="max-w-5xl mx-auto">
  <!-- Page header -->
  <div class="text-center my-8">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Upload Initial Requirements</h1>
    <p class="mt-2 text-gray-600">Please upload the required documents to complete your application.</p>
  </div>
  <!-- Optional return link -->
  <div class="text-center -mt-4 mb-4" ng-if="vm.returnUrl">
    <a class="inline-flex items-center text-sm text-blue-700 hover:text-blue-800 underline"
       ng-href="{{ vm.returnUrl }}">
      <i class="fas fa-arrow-left mr-1"></i>
      Back to application
    </a>
  </div>

  <!-- Loading state -->
  <div ng-if="vm.loading" class="flex items-center justify-center py-16">
    <div class="flex items-center text-gray-600">
      <svg class="animate-spin h-5 w-5 mr-3 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      Loading your requirements...
    </div>
  </div>

  <!-- Content -->
  <div ng-if="!vm.loading">
    <!-- Invalid/expired link panel -->
    <div ng-if="vm.invalid" class="bg-yellow-50 border border-yellow-200 text-yellow-900 rounded-md p-6 mb-6 text-center">
      <i class="fas fa-link-slash text-2xl mb-2"></i>
      <h2 class="text-xl font-semibold mb-2">Invalid or Expired Link</h2>
      <p class="text-sm mb-3">The upload link you used is invalid or has expired.</p>
      <p class="text-sm">
        Contact Admissions at
        <a class="underline text-blue-700 hover:text-blue-800" ng-href="mailto:{{ vm.supportEmail }}">{{ vm.supportEmail }}</a>.
      </p>
      <button type="button"
              class="mt-3 inline-flex items-center px-3 py-1.5 border border-blue-200 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100"
              ng-click="vm.copySupportEmail()">
        <i class="fas fa-clipboard mr-2"></i> Copy Email
      </button>
    </div>

    <!-- Generic error panel -->
    <div ng-if="!vm.invalid && vm.error" class="mb-6">
      <div class="bg-red-50 border border-red-200 text-red-800 rounded-md p-4">
        <div class="flex">
          <i class="fas fa-exclamation-triangle mt-0.5"></i>
          <div class="ml-3 text-sm">
            {{ vm.error }}
          </div>
        </div>
      </div>
    </div>
    <!-- Student summary -->
    <div class="bg-white shadow border border-gray-200 rounded-lg p-5 mb-6" ng-if="!vm.invalid">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
          <div class="text-gray-900 font-semibold">
            {{ (vm.student.first_name || '') + ' ' + (vm.student.last_name || '') | trim }}
          </div>
          <div class="text-gray-600 text-sm">
            {{ vm.student.email }}
          </div>
        </div>
        <div class="mt-3 md:mt-0">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                ng-class="{
                  'bg-blue-100 text-blue-800': vm.student.student_type === 'college',
                  'bg-green-100 text-green-800': vm.student.student_type === 'shs',
                  'bg-purple-100 text-purple-800': vm.student.student_type === 'grad',
                  'bg-gray-100 text-gray-800': !vm.student.student_type
                }">
            <i class="fas fa-user-graduate mr-1"></i>
            {{ vm.student.student_type || 'unknown level' }}
          </span>
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div class="bg-blue-50 border border-blue-100 text-blue-800 rounded-md p-4 mb-6" ng-if="!vm.invalid">
      <div class="flex">
        <div class="flex-shrink-0">
          <i class="fas fa-info-circle mt-0.5"></i>
        </div>
        <div class="ml-3 text-sm">
          <p>
            Only PDF, Excel (xls, xlsx, csv), and image files (jpg, jpeg, png, gif, webp) up to 10MB are accepted. You can upload files individually for each requirement. You may replace an already uploaded file at any time.
          </p>
        </div>
      </div>
    </div>

    <!-- Requirements list -->
    <div class="bg-white shadow border border-gray-200 rounded-lg overflow-hidden" ng-if="!vm.invalid">
      <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Your Requirements</h2>
        <button class="text-sm text-blue-600 hover:text-blue-700" ng-click="vm.reload()">
          <i class="fas fa-sync-alt mr-1"></i> Refresh
        </button>
      </div>

      <div class="divide-y divide-gray-100">
        <div class="p-4" ng-repeat="item in vm.items track by item.app_req_id">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <!-- Requirement info -->
            <div class="mb-3 md:mb-0 md:pr-4">
              <div class="flex items-center">
                <span class="text-gray-900 font-medium mr-3">{{ item.name }}</span>
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                      ng-class="{
                        'bg-blue-100 text-blue-800': item.type === 'college',
                        'bg-green-100 text-green-800': item.type === 'shs',
                        'bg-purple-100 text-purple-800': item.type === 'grad',
                        'bg-gray-100 text-gray-800': !item.type
                      }">
                  {{ item.type || 'n/a' }}
                </span>
              </div>
              <div class="text-sm text-gray-600 mt-1" ng-if="item.description">
                {{ item.description }}
              </div>

              <div class="mt-2">
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium"
                      ng-class="item.submitted_status ? 'bg-emerald-100 text-emerald-800' : 'bg-amber-100 text-amber-800'">
                  <i class="fas" ng-class="item.submitted_status ? 'fa-check-circle mr-1' : 'fa-exclamation-circle mr-1'"></i>
                  {{ item.submitted_status ? 'Submitted' : 'Pending' }}
                </span>

                <a ng-if="item.file_link" ng-href="{{ item.file_link }}" target="_blank"
                   class="ml-3 inline-flex items-center text-sm text-blue-600 hover:text-blue-700">
                  <i class="fas fa-external-link-alt mr-1"></i> View file
                </a>
              </div>
            </div>

            <!-- Actions -->
            <div class="w-full md:w-auto">
              <div class="flex items-center md:justify-end">
                <!-- Hidden file input per row for replace -->
                <input type="file"
                       id="file-input-{{item.app_req_id}}"
                       class="hidden"
                       accept="{{ vm.accept }}"
                       ngf-select
                       ng-model="hiddenFileModel"
                       ngf-change="vm.onSelect(item, hiddenFileModel)">

                <label class="sr-only" for="upload-{{item.app_req_id}}">Upload file</label>

                <div class="flex items-center space-x-2">
                  <!-- Drag & drop zone -->
                  <div class="hidden md:block">
                    <div class="w-40 px-3 py-2 border-2 border-dashed border-gray-300 rounded text-xs text-gray-600 text-center"
                         ngf-drop
                         ngf-multiple="false"
                         ngf-allow-dir="false"
                         ngf-change="vm.onDrop(item, $files)"
                         accept="{{ vm.accept }}"
                         ng-disabled="vm.uploading[item.app_req_id]">
                      Drag &amp; drop
                    </div>
                  </div>

                  <button ng-if="!item.submitted_status"
                          class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50"
                          ngf-select
                          ng-model="fileModel"
                          ngf-change="vm.onSelect(item, fileModel)"
                          accept="{{ vm.accept }}"
                          ng-disabled="vm.uploading[item.app_req_id]">
                    <i class="fas fa-upload mr-2"></i>
                    {{ vm.uploading[item.app_req_id] ? 'Uploading...' : 'Upload' }}
                  </button>

                  <button ng-if="item.submitted_status"
                          type="button"
                          class="inline-flex items-center px-3 py-2 border border-blue-200 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 disabled:opacity-50"
                          ng-click="vm.replaceFile(item)"
                          ng-disabled="vm.uploading[item.app_req_id]">
                    <i class="fas fa-sync-alt mr-2"></i>
                    {{ vm.uploading[item.app_req_id] ? 'Uploading...' : 'Replace file' }}
                  </button>

                  <!-- Progress -->
                  <div class="w-40" ng-if="vm.uploading[item.app_req_id]">
                    <div class="h-2 w-full bg-gray-200 rounded">
                      <div class="h-2 bg-blue-600 rounded" ng-style="{ width: vm.progress[item.app_req_id] + '%' }"></div>
                    </div>
                    <div class="text-right text-xs text-gray-600 mt-1">
                      {{ vm.progress[item.app_req_id] || 0 }}%
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Empty state -->
        <div class="p-6 text-center text-gray-600" ng-if="!vm.items || vm.items.length === 0">
          No requirements found for your level at this time.
        </div>
      </div>
    </div>

    <!-- Footer note -->
    <div class="text-xs text-gray-600 mt-4" ng-if="!vm.invalid">
      Having trouble? Contact Admissions:
      <a class="underline text-blue-700 hover:text-blue-800" ng-href="mailto:{{ vm.supportEmail }}">{{ vm.supportEmail }}</a>
      <button type="button"
              class="ml-2 inline-flex items-center px-2 py-0.5 border border-blue-200 rounded text-blue-700 bg-blue-50 hover:bg-blue-100"
              ng-click="vm.copySupportEmail()">
        <i class="fas fa-clipboard mr-1"></i> Copy
      </button>
    </div>
  </div>
</div>
